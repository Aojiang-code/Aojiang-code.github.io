# 1.5 因果图（DAG）与变量选择（入门强化版）

## 1）为什么一定要画 DAG？

* **决定“该调谁、不该调谁”**：DAG 告诉你需要阻断哪些**背门路径**（confounding paths），哪些变量**不能调整**（中介/碰撞）。
* **明确时间顺序**：所有“**用于调整的协变量**”必须是**治疗前**信息。
* **让假设可被讨论**：没有 DAG，团队就会“各说各话”；有 DAG，争论点变成“这条边该不该画”。

---

## 2）DAG 的基本组件与路径类型

### 变量与边

* **节点（X, Y, Z, …）**：变量（治疗、结局、协变量）
* **有向边**：因果影响（X→Y 表示 X 直接影响 Y）
* **无环**（Acyclic）：不允许从一个节点出发沿箭头回到自己

### 三种基本关系（记住就会用）

1. **链/叉（会“开路”）**：

   * 链：$X \rightarrow Z \rightarrow Y$
   * 叉：$X \leftarrow Z \rightarrow Y$（Z 是**混杂**）
     **若不条件化 Z，路径是“开”的**；若**条件化 Z**（控制/分层/回归），路径被“**阻断**”。

2. **碰撞（会“关路”，但一旦条件化就“开路”）**：

   * $X \rightarrow A \leftarrow U$（A 是**碰撞变量**）
     **默认“关路”**；**若条件化 A**（或 A 的后代），路径被**打开** → **碰撞偏倚**。

3. **中介**：

   * $X \rightarrow M \rightarrow Y$（M 是**中介**）
     估**总效应**时不要在 PS/背门调整集中放 M（否则会“挡掉”效应的一部分）。
     做**中介分析**时另起模型。

---

## 3）背门准则与“最小充分调整集”（MSAS）

**目标**：阻断所有从 X 到 Y 的**背门路径**（有一个箭头指向 X 的路径）。
**做法**：

1. 画出 X（治疗）→ Y（结局）与其可能的共同原因；
2. 找出所有**背门路径**；
3. 只用**X 的非后代**中的一组变量把这些路径“堵住”；
4. 这一组里，若去掉任何一个就“漏路”，它就是**最小充分调整集**（MSAS）。

> 口诀：**只调治疗前的“共同原因”，不调中介/碰撞/治疗后变量。**

---

## 4）医学例子（从简到繁）

### 4.1 药物 X → 血压 Y（Age 是混杂）

```
Age  →  X
Age  →  Y
X    →  Y
```

* **背门路径**：X ← Age → Y
* **MSAS**：{Age}（调整 Age 即可）

### 4.2 ICU 升压药 X → 28 天死亡 Y（SOFA 是混杂；MAP\_after 是中介）

```
SOFA (治疗前严重度) →  X
SOFA (治疗前严重度) →  Y
X → MAP_after (治疗后血压) → Y
X → Y
```

* **背门**：X ← SOFA → Y → **要调 SOFA**
* **中介**：MAP\_after 是治疗后变量 → **不要**放进 PS/背门调整集（估总效应）

### 4.3 仅纳入“住进 ICU 的人”可能引入**碰撞**

```
Disease_severity → ICU_admission ← Bed_capacity
X (治疗) → ICU_admission  （有时也会）
ICU_admission → 进入样本（条件化）
```

* \*\*条件化 ICU\_admission（碰撞）\*\*后，X 与一些未观测因素会“凭空相关” → **避免在碰撞或其后代上做条件化**。

---

## 5）变量选择决策表（放在显示器边上）

| 角色       | 判定要点           | 放进 PS/背门调整集？     | 放进结果模型？    | 备注          |
| -------- | -------------- | ---------------- | ---------- | ----------- |
| **混杂**   | 治疗前；同时影响 X 与 Y | ✅ 必须             | ✅ 常放       | 关键；SMD/重叠检查 |
| **中介**   | X→M→Y（治疗后）     | ❌（估总效应）          | ⚠️ 中介分析专用  | 否则会“挡掉”效应   |
| **碰撞**   | X→A←U（共同结果）    | ❌ 不能             | ❌ 不能       | 条件化会引入虚假关联  |
| **效应修饰** | 效应因 W 不同而变     | ⚠️ 可不调；做 CATE/交互 | ✅ 建议纳入或做交互 | 报告异质性       |

> **PS 模型**：只放**治疗前混杂**（和少量有助于建模但不会引偏的基线变量）。
> **结果模型**（如 DR/TMLE）：可包含相同的治疗前混杂、必要的非线性/交互；**不要**用治疗后信息来“提准”。

---

## 6）动手：用 Python 画一个小 DAG

### 6.1 `networkx` 画图（轻量）

```python
import networkx as nx
import matplotlib.pyplot as plt

G = nx.DiGraph()
edges = [
    ("Age","Drug"), ("Age","BP"),
    ("Severity","Drug"), ("Severity","BP"),
    ("Drug","BP"),
    ("Drug","BP_post"), ("BP_post","BP")  # BP_post 视作治疗后指标/中介
]
G.add_edges_from(edges)

plt.figure(figsize=(6,4))
pos = nx.spring_layout(G, seed=2025)  # 简单布局
nx.draw(G, pos, with_labels=True, node_size=1800, node_color="#E6F3FF", arrowsize=20)
plt.title("DAG: Drug -> BP with Confounders & Mediator")
plt.show()
```

### 6.2 用 `DoWhy` 求出“需要调整谁”（自动给出调整集）

> 注意：这里只演示“**识别**”环节，数据可用“空壳”占位。

```python
import pandas as pd
from dowhy import CausalModel

# 仅为了让 DoWhy 初始化，通过一个空 DataFrame 声明变量列
cols = ["Age","Severity","Drug","BP","BP_post"]
df = pd.DataFrame({c: [] for c in cols})

graph = r"""
digraph {
Age -> Drug; Age -> BP;
Severity -> Drug; Severity -> BP;
Drug -> BP;
Drug -> BP_post; BP_post -> BP;
}
"""

model = CausalModel(
    data=df,
    treatment="Drug",
    outcome="BP",
    graph=graph
)
identified = model.identify_effect()
print(identified)
```

**你会看到**：DoWhy 报告一个**背门调整集**（如 `{Age, Severity}`），而**不会**建议调整 `BP_post`（它是中介）。

> 小技巧：先用 **DAGitty** 把 DAG 画好（可自动建议最小调整集），再把图结构粘到 DoWhy 里做“识别→估计”。

---

## 7）从 DAG 到变量清单：一步步落地

1. **画初版 DAG**（先少后多）：X、Y、核心临床路径、显而易见的共同原因
2. **只列“治疗前”候选协变量**（入院前/给药前可得）
3. **找背门路径 → 选择 MSAS**（避免中介/碰撞/后代）
4. **把 MSAS 放进 PS 模型**（PSM/IPTW/DR）；检查 **SMD 与重叠性**
5. **必要时加点灵活性**：非线性/分段/交互项（在结果模型里）
6. **报告**：清楚写出 DAG 假设、最终调整集、平衡/重叠诊断与敏感性分析

---

## 8）时间相关与动态治疗（预告）

当“**之前的治疗影响之后的混杂**，又影响后续治疗与结局”（常见于 ICU 连续干预、纵向药物），传统背门/PS 会失效。

* 需要用 **G 方法**（如 **边际结构模型 MSM** + **时间依赖 IPTW**）、**g-computation**、**TMLE** 等。
* 入门做法：从**单时点**问题练熟，再逐步扩展到**多时点**框架。

---

## 9）常见坑（务必避免）

* **把治疗后变量当混杂**（如 BP\_post），会严重低估（或扭曲）治疗效应
* **在碰撞或其后代上条件化**（如“只分析 ICU 入住者”却不建模此选择过程）
* **把“强相关的预测因子”当混杂**：只与 Y 相关、但与 X 无关的变量不是混杂，随意调整可能**增方差**甚至引偏
* **未做平衡/重叠/敏感性报告**：即便方法对，诊断缺失也难以说服同行

---

## 10）把它塞进你的项目模板（可直接抄用）

**DAG → 调整集 → 代码变量清单**

```python
# 你最终确定的最小充分调整集（来自 DAGitty/DoWhy）
pre_covs = ["Age", "Severity", "ComorbidityIndex", "ArrivalSource"]  # 例子

# 规则：
# - PS 模型：只放 pre_covs（+ 少量建模必需的基线变量）
# - 结果模型（DR/TMLE等）：可放 pre_covs + 合理的非线性/交互（仍然是治疗前信息）
# - 明确排除：治疗后变量（如 BP_post）、中介、碰撞及其后代
```

---

### 小结（给入门者的三句话）

1. **先画 DAG 再建模**：背门路径一目了然，变量选择就不乱。
2. **最小充分调整集**：只调治疗前“共同原因”，不调中介/碰撞。
3. **诊断与报告**一样重要：SMD、重叠、敏感性写清楚，才能让结论可信。

---

配套代码:`105_DAG_MSAS_notebook.ipynb`

