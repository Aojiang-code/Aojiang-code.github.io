# 1.2 Pearl_因果推断三层次（Causal Hierarchy · 入门强化版）

> **一句话总览**
>
> * **关联（Association）**：世界不动，只观察 → “它们一起变吗？”
> * **干预（Intervention）**：把世界拨一下 → “我动X，Y会怎样？”
> * **反事实（Counterfactual）**：比较两个平行世界 → “对同一名患者，做与不做的‘差值’是多少？”

---

## 一、1️⃣ 关联（Association）

### 在问什么？

> **已知X的取值，Y发生的概率/均值是多少？**
> 数学对象：$P(Y \mid X)$

### 医学例子

* “吸烟者的肺癌发生率更高”
* “SOFA 分高的 ICU 患者死亡率更高”
* “CRP 高与感染并发症更多相关”

### 数据 & 方法

* **数据**：横断面/队列/病历数据，**只要能量化相关性即可**
* **方法**：相关系数、卡方、t检验、**logistic/线性回归**、随机森林、XGBoost、深度学习
* **指标**：OR/β 系数、AUC、校准、RMSE 等

### 能做/不能做

* ✅ 发现线索、构建风险模型、变量筛选
* ❌ 不能回答“如果我改变X，Y会不会变”（**不具因果解释力**）

### 常见误区

* 把回归系数、特征重要性当作“因果效应”
* 用**治疗后**信息去增强预测（会提高AUC），然后错误地解释为“治疗有效/无效”

---

## 二、2️⃣ 干预（Intervention）

### 在问什么？

> **如果我把变量X强制设为某值（做干预），Y会变成什么？**
> 数学对象：$P(Y \mid do(X=x))$

### 医学例子

* “对败血症患者在**3小时内**给予抗生素，是否降低 28 天死亡率？”
* “术前β受体阻滞剂会不会减少围术期心梗？”

### 数据 & 方法（两条路）

1. **随机对照试验（RCT）**：直接估计 $P(Y \mid do(X))$（金标准，但成本/伦理/可行性受限）
2. **观察性数据 + 识别策略**：把 $P(Y \mid do(X))$ **等价换形**为可观测量（需假设）

   * **背门法则（Backdoor）**：选一组**治疗前混杂** $Z$，用标准化/回归/PSM/IPTW/DR 等调整

     $$
     P(Y \mid do(X)) \;=\; \sum_z P(Y \mid X, Z=z)\,P(Z=z)
     $$
   * **工具变量（IV）**：当存在不可测混杂时，借助“只影响治疗、不直接影响结局”的变量（如处方偏好、排班差异）
   * **前门（Front-door）**：有明确中介且路径可识别时使用（临床较少见）
   * **G-方法**：G-formula、G-computation、TMLE（灵活、兼容机器学习）

### 必要假设（背门/PS 类方法的“入门三件套”）

* **可交换性/可忽略性（Ignorability）**：给定 $Z$ 后，治疗分配与潜在结局独立
* **重叠/可得性（Positivity）**：任意 $Z$ 取值下，接受/不接受治疗的概率都大于0
* **一致性（Consistency） & 无干扰（SUTVA）**：实际接受的治疗与“定义的治疗”一致、患者之间互不干扰

> ⚠️ **重点**：干预层级的核心是\*\*“识别”\*\*：确定在你的数据与假设下，$P(Y \mid do(X))$ 是否能用观测量表示；能 → 估计，不能 → 换设计/换问题。

### 常用产出

* ATE（平均处理效应）、ARR（绝对风险差）、RR/OR/HR（风险比/赔率比/风险比率）
* 平衡性（SMD/Love plot）、PS 重叠图、敏感性分析（未测混杂、截尾、负控等）

### 常见误区

* 在PS模型里加入**治疗后**变量（中介/后门开路）
* 忽视极端倾向（PS≈0/1），IPTW 权重爆炸
* 只报点估计，不做敏感性分析与稳健性检查

---

## 三、3️⃣ 反事实（Counterfactuals）

### 在问什么？

> **对同一名患者**，如果被治疗 vs 未被治疗，结局各是多少？差多少？
> 潜在结局：$Y_i(1), Y_i(0)$；个体效应：$\tau_i = Y_i(1)-Y_i(0)$

### 医学例子

* “这位 72 岁、SOFA=9 的患者，**用了**早期抗生素并存活；**如果没用**，会怎样？”
* “A 手术后无复发；若选择 B 术式，是否会复发？”

### 数据 & 方法

* **数据**：与干预层级相同，但为了“个体/亚组差异”，常需**更丰富的协变量**与**充足重叠**
* **方法**：

  * **结构因果模型（SCM）/反事实推断**（更理论化；用于严格定义与证明）
  * **个体化/条件化效应（ITE/CATE）**：T/X/DR-learner、因果森林、X/TARNet/DragonNet、EconML/DoWhy 等
  * **中介分析**（自然直接/间接效应，涉及跨世界假设，需谨慎）
* **产出**：CATE（某一类人群的平均效应）、ITE（个体层），支持**个性化治疗策略**

### 难点与风险

* **“跨世界”量不可观测**：同一人不可能同时接受/不接受，需依赖模型与假设
* **外推性**：当个体特征在训练数据支持度不足，个体化效应会不稳
* **易与“预测谁受益”混淆**：ITE 是因果问题，不是“预测标签”

---

## 四、三层如何“上楼梯”？（从低到高的实操路径）

> **目标**：把你手头的医学问题，按“层级→假设→方法→验证”一步步落地。

1. **从 关联 到 干预**

   * 画一个简易 **DAG**，先列出**治疗前混杂**
   * 检查 **重叠**（PS 分布） & **基线平衡**（SMD）
   * 选择识别策略：背门（PSM/IPTW/DR/G-formula）或 IV/前门
   * 做敏感性分析（未测混杂、截尾、负控/负控结果）

2. **从 干预 到 反事实**

   * 先得到**可靠的平均效应**（ATE）
   * 再做 **CATE/ITE**（分层或个性化模型），并**约束外推**（只在有重叠的区域解释）
   * 对个体化结论做**稳定性**与**解释性**检查（例如加入临床可解释特征、可视化决策边界）

---

## 五、两个最常见的因果图（ASCII 版）

### 5.1 混杂（最常见）

```
Z  →  X  →  Y
 \        ↑
  └───────┘  (Z 同时影响 X 和 Y)
```

* 例：年龄/严重度 Z 影响“是否给药” X，也影响死亡 Y
* **解法**：背门（调整 Z）

### 5.2 中介（治疗后变量，勿入PS）

```
X  →  M  →  Y
```

* 例：给药 X 改善血压 M，进而影响死亡 Y
* **注意**：若要估总效应，**PS/背门阶段不要把 M 放入调整集**；做中介分析时另行建模

---

## 六、把三层应用到论文/项目（你可以直接照抄的清单）

* **问题分层**：我是在做“相关性/预测”、还是“干预效应”、还是“个体化反事实”？
* **数据**：是否有**治疗前协变量**、时间顺序清楚、重叠性充足？
* **识别**：我的 $P(Y \mid do(X))$ 能被什么规则识别（背门/前门/IV/G-方法）？
* **方法**：选择 PSM/IPTW/DR/G-formula/IV/因果森林/金标准 RCT
* **验证**：平衡、重叠、敏感性分析、稳健性检查、亚组一致性
* **解释**：平均效应 + 异质性（CATE），临床意义与外推边界

---

## 七、三层对照表（便于背诵）

| 层级  | 数学对象               | 核心问题      | 典型方法                                | 医学用途       | 主要风险           |
| --- | ------------------ | --------- | ----------------------------------- | ---------- | -------------- |
| 关联  | $P(Y\mid X)$       | 现在不动，Y会多少 | 相关/回归/ML                            | 风险分层、变量筛选  | 混杂、选择偏倚        |
| 干预  | $P(Y\mid do(X))$   | 动X，Y会怎样   | RCT；背门（PSM/IPTW/DR/G-formula）；IV/前门 | 评估治疗是否有效   | 识别失败、极端PS、时间倒置 |
| 反事实 | $Y(1)-Y(0)$ / CATE | 同一个体两世界差值 | SCM；CATE/ITE 模型；中介分析                | 个性化决策、机制分解 | 跨世界假设、外推不稳     |

---

## 八、入门者常见三问

1. **“我只有观察数据，能做因果吗？”**
   可以，但**先问识别**：能否找到足够的治疗前混杂并满足重叠与一致性？做不到就换策略（IV/前门），再不行就**别下因果结论**。

2. **“我想做个体化效应（ITE）？”**
   先把**ATE做稳**（平衡/重叠/敏感性），再做 CATE/ITE，并只在**重叠区域**解读。

3. **“为什么我的 IPTW 很不稳定？”**
   看 PS 分布，若极端概率多，考虑**修剪**（如去掉 PS<0.01 或 >0.99），或换 DR/TMLE，并报告稳健性。

---

配套代码:`001_Env_Check_and_Quickload.ipynb`

