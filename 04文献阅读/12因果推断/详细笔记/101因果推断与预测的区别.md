# 1.1 因果推断与预测的区别（入门者强化版）

## 1）一句话区分

* **预测（Predictive Modeling）**：回答“**现在不给我动系统、只看现状**，结果会是多少？”——形式是相关性，目标是**准确预测**。
* **因果推断（Causal Inference）**：回答“**如果我做了某个干预**，结果会怎样变化？”——形式是干预反事实，目标是**估计效果**（effect）。

> 关键词对照：
> 预测 → 相关、泛化误差、AUC/RMSE、P(Y∣X)
> 因果 → 干预、反事实、ATE/ITE、P(Y∣do(X))

---

## 2）医学里的两个典型问题（同一病人、不同问题）

* **预测问题**：ICU 入院 24 小时内，用病人的年龄、性别、SOFA、化验等特征，**预测其 28 天死亡的风险**有多大？

  * 使用：风险分层、资源调度、家属沟通。
  * 指标：AUC、Brier score、校准度（calibration）。
  * 不回答：如果我给抗生素/升压药，**死亡率会降低吗**？

* **因果问题**：对类似的败血症患者，**早期（3 小时内）抗生素**是否会**降低 28 天死亡率**，下降多少？

  * 使用：治疗策略决策、指南制定、真实世界证据。
  * 指标：ATE/ARR/RR/HR、SMD 平衡性、重叠性、敏感性分析。
  * 不追求：单病人死亡概率预测得多准。

二者侧重点不同：**预测**帮你“看风险”，**因果**帮你“改结果”。

---

## 3）同一数据、不同问题：到底在问什么？

| 维度       | 预测           | 因果                        |
| -------- | ------------ | ------------------------- |
| **核心问题** | 给定特征，Y 会是多少？ | 若**干预**X，Y 会怎样变？          |
| **数学对象** | P(Y∣X)       | P(Y∣do(X))，或 Y(1)−Y(0)    |
| **数据要求** | 可预测即可        | 可识别（有足够的混杂信息、时间顺序清楚、重叠性）  |
| **评价指标** | AUC、RMSE、校准  | ATE/HR、平衡性(SMD)、重叠性、敏感性分析 |
| **医学例子** | 预测 ICU 死亡风险  | 早期抗生素是否降低 ICU 死亡率         |

---

## 4）最小符号与直觉（看懂论文不迷糊）

### 4.1 预测的数学量

* **条件分布**：$P(Y\mid X)$。
  例：已知年龄、SOFA、乳酸，预测死亡概率 $\hat p$。

### 4.2 因果的数学量（潜在结局）

* **潜在结局**：对每位患者 $i$，

  * $Y_i(1)$：接受治疗时的结局；
  * $Y_i(0)$：不接受治疗时的结局。
* **个体效应**：$\tau_i = Y_i(1) - Y_i(0)$（不可同时观测）。
* **平均处理效应（ATE）**：$\mathbb{E}[Y(1)-Y(0)]$。

> 直觉：预测是在问“**这个世界里**会发生什么”；因果是在问“**如果我们把世界改一下**会怎样”。

---

## 5）为什么“好预测 ≠ 好因果”？

* 预测模型会把**与结局强相关**的所有变量都用上（包括**中介**和**碰撞**），以提升准确率；
* 但因果估计只能用**治疗前的混杂**做调整，**不能**调整中介/碰撞，否则**估计会偏**；
* 预测用 AUC 高不代表“给药有效”；给药变量即使进入预测模型，也**不能**据此断言“给药有因果作用”。

**例**：ICU 病情更重（SOFA 高）→ 更容易被使用升压药（治疗），也更容易死亡。

* 纯预测会学到“用药 ↔ 死亡”正相关，但那**不是**“用药导致死亡”，而是**重症混杂**。

---

## 6）两条“最小落地”流程（各 5 步）

### 6.1 做**预测**（ICU 死亡风险）

1. 明确目标：预测 28 天死亡率。
2. 选特征：年龄、性别、SOFA、化验……（**能提升预测就上**）。
3. 划分集：训练/验证/测试；避免泄露（如用入院后未来信息）。
4. 训练评估：AUC、校准曲线、Brier score。
5. 部署与监控：漂移监控、再训练计划。

### 6.2 做**因果**（早期抗生素的效果）

1. 明确**治疗/结局/时间**：3 小时内抗生素（X），28 天死亡（Y），协变量只取**治疗前**。
2. 识别混杂：年龄、SOFA、感染部位、入院来源、合并症等（画**DAG**）。
3. 估计倾向评分并检查**平衡**与**重叠**：SMD≤0.1/0.2，PS 重叠良好。
4. 估计效果：IPTW/匹配/DR；报告 ATE、RR/HR，并做**敏感性分析**。
5. 解释与稳健性：亚组、截尾、不同模型对比、负控。

---

## 7）一个极简的可运行演示（同样数据，不同结论）

> 目的：同一份“有混杂”的模拟数据，**预测**看起来“给药=死亡更高”，但**因果**校正后发现“给药降低死亡”。

```python
import numpy as np, pandas as pd
from sklearn.linear_model import LogisticRegression
from sklearn.metrics import roc_auc_score
from sklearn.preprocessing import StandardScaler

np.random.seed(42)
n = 3000
age = np.random.normal(70, 10, n)            # 混杂：年龄越大越重
sofa = np.clip(np.random.normal(5 + 0.1*(age-70), 2, n), 0, None)

# 治疗分配：越重越容易用药
logit_t = -2 + 0.4*sofa + 0.01*(age-70)
p_treat = 1/(1+np.exp(-logit_t))
treat = (np.random.rand(n) < p_treat).astype(int)

# 真正的因果：用药可以降低死亡（负向效果），但重症本身提高死亡
logit_y = -3 + 0.5*sofa + 0.02*(age-70) - 0.6*treat
p_dead = 1/(1+np.exp(-logit_y))
y = (np.random.rand(n) < p_dead).astype(int)

df = pd.DataFrame({'age':age,'sofa':sofa,'treat':treat,'dead':y})

# —— 预测：用“treat, age, sofa”预测死亡 —— #
X_pred = df[['treat','age','sofa']]
m_pred = LogisticRegression(max_iter=1000).fit(X_pred, y)
print("预测AUC:", roc_auc_score(y, m_pred.predict_proba(X_pred)[:,1]))
print("预测模型中 treat 系数（相关方向）:", m_pred.coef_[0][0])

# —— 因果：简单 IPTW 估计 ATE（示范，不是生产级） —— #
# 倾向评分
scaler = StandardScaler()
X_ps = scaler.fit_transform(df[['age','sofa']])
m_ps = LogisticRegression(max_iter=1000).fit(X_ps, df['treat'])
ps = m_ps.predict_proba(X_ps)[:,1]

# 稳定化权重
w = np.where(df['treat']==1, 1/ps, 1/(1-ps))
# 加权后的两组死亡率差（ATE 的一种朴素实现）
ate_iptw = (w[df.treat==1]*df.dead[df.treat==1]).sum()/w[df.treat==1].sum() \
         - (w[df.treat==0]*df.dead[df.treat==0]).sum()/w[df.treat==0].sum()
print("IPTW 估计的 ATE（>0=增加死亡，<0=降低死亡）:", ate_iptw)
```

**常见现象**：

* 预测模型里，`treat` 的系数可能“显得”让死亡变高（因为重症更容易被治疗——**混杂**）；
* 但 IPTW 后的 ATE < 0（负值），反映“治疗降低死亡”的**因果效应**（更接近“真相设定”）。

> 这段演示只是帮助直觉入门：**预测看到的是“谁更像会死亡的人”**，**因果纠正后才回答“给药是否改变了死亡”**。

---

## 8）什么时候用预测，什么时候用因果？（临床友好判定表）

* **只做分层/提醒/分配资源** → 用**预测**

  * 例：再入院风险评分、ICU 入科早期恶化评分
* **要指导治疗决策/评估干预效果** → 用**因果**

  * 例：早期抗生素/液体复苏/降压目标是否降低死亡/并发症
* **两者结合**：先用**预测**找“高危亚群”，再用**因果**估“这些人**用药能否获益**”（个体化治疗效果 ITE/CATE）

---

## 9）常见误区（新手最容易踩的坑）

1. **用 AUC 高的模型去证明某治疗有效**（错）：AUC 高 ≠ 因果有效。
2. **用治疗后信息当混杂**（错）：会引入偏倚（中介/碰撞）。
3. **不检查重叠性（positivity）**：极端倾向会让加权发散、不可靠。
4. **只报平均效应**：忽略异质性（老人 vs 青年、不同基线严重度）。
5. **没做敏感性分析**：未测混杂的影响没评估，结论不稳。

---

## 10）把概念落地（你可以直接用的最小清单）

* **做预测**：
  1）定义目标；2）拆分训练/验证/测试；3）评估 AUC/校准；4）检查泄露；5）部署与监控。
* **做因果**：
  1）定义治疗/结局/时间线；2）列出治疗前混杂并画 DAG；
  3）估 PS、查 SMD 与重叠；4）用 PSM/IPTW/DR 估效应（ATE/HR/CATE）；
  5）做敏感性、亚组、稳健性分析。

---

配套代码:`101_Predict_vs_Causal.ipynb`

