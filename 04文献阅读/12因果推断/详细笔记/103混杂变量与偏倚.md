# 1.3 混杂变量与偏倚（入门者强化版）

> **一句话直觉**
>
> * **混杂变量（Confounder）**：同时影响“是否治疗”（X）和“结局”（Y）的**治疗前**因素。若不控制，会把治疗与结局“搅在一起”，让我们把**相关**误当**因果**。
> * **偏倚（Bias）**：让估计系统性偏离真实值的原因（不仅有混杂造成的偏倚，还有选择偏倚、测量偏倚、遗漏变量偏倚、时间相关偏倚等）。

---

## 1）什么是混杂？怎样在图上看出来？

### 定义与图示（DAG）

```
Z  →  X  →  Y
 \        ↑
  └───────┘
```

* **Z**：混杂（治疗前变量），同时影响 **X（治疗/暴露）** 与 **Y（结局）**
* 如果不控制 **Z**，X 与 Y 之间的“表面关联”可能主要来自 Z →（**混杂偏倚**）

### 医学里的典型例子

* **重症度**：在 ICU，SOFA 分高的患者更可能用升压药（X），也更容易死亡（Y）——若不控制 SOFA，就会“看上去”**用药更致死**。
* **职业**：研究吸烟（X）→肺癌（Y），矿工的职业暴露（Z）既促使吸烟，又提高肺癌风险。
* **年龄/合并症**：老年人（Z）更可能接受干预（X），也有更高事件率（Y）。

### 判断是否纳入混杂的**三要素**

1. **治疗前**（timing 上在 X 之前可获得）；
2. **同时影响 X 与 Y**（是 X 与 Y 的**共同原因**）；
3. **不是**中介、不是碰撞变量（见下节）。

---

## 2）与混杂容易混淆的三个角色

### 2.1 **中介（Mediator）**：X 影响 M，M 影响 Y（X→M→Y）

* 例：降压药（X）→ 降低血压（M）→ 减少卒中（Y）
* **估总效应时不要在 PSM/IPTW 的调整集中放 M**；否则会“挡掉”部分真实效应。

### 2.2 **碰撞变量（Collider）**：X→A←U（A 是 X 与某未观测因素 U 的**共同结果**）

* 一旦**条件化**（筛选/建模中控制）A，反而打开了 X↔U 的虚假通路，产生**碰撞偏倚**。
* 例：仅分析“接受某检查且结果异常”的人群；检查异常（A）是治疗与病情共同结果，条件化会引假关联。

### 2.3 **效应修饰（Effect Modifier）**：X→Y 的**效应大小**随 W 的水平不同而改变

* 例：β受体阻滞剂对年轻 vs 老年患者的效果不同。
* **不是**偏倚来源；是值得报告的“异质性”（可做 CATE/亚组分析）。

---

## 3）常见偏倚类型（医学常会遇到，记住它们的“症状”）

1. **选择偏倚（Selection Bias）**

   * **抽样/纳入不当**：只看住进 ICU 的患者，不代表全部重症人群；
   * **随访流失**：失访与结局相关；
   * **不朽时间偏倚（Immortal Time Bias）**：把“必须活到某时点才能接受治疗”的时间算到治疗组里，治疗组**被动占便宜**。
   * **渠道偏倚 / 指征混杂**：重症更可能被治疗（即“按指征用药”），造成治疗与差结局的正相关。

2. **测量偏倚（Measurement Bias）**

   * **错分/误差**：将有病误记为无病（敏感度低），或把未治疗记成已治疗；
   * **非差异性错分**（两组同程度错分）→ 往往把效应“稀释”；
   * **差异性错分**（两组不同）→ 偏倚方向不可预知；
   * **仪器/流程变化**：不同医院、时段的化验方法改变导致系统性差异。

3. **遗漏变量偏倚（Omitted Variable Bias, OVB）**

   * 关键混杂 **Z** 没有测到/没纳入，回归把它“借”到治疗系数上，方向大小取决于 **Z–X** 与 **Z–Y** 的相关方向与强度。
   * 例：缺少“疾病严重度”，会把“重症导致死亡”的效应归到“使用升压药”上。

> 还有：**时间相关混杂**（Time-varying confounding）、**健康使用者偏倚**、**知情时间偏倚**等，后续进阶会覆盖。

---

## 4）如何处理混杂？（从设计到分析的实操清单）

### 4.1 研究设计阶段（能做则优先）

* **随机化（RCT）**：从源头打散混杂（可行性/伦理/成本限制）。
* **限制/分层**：限制纳入范围（如仅首发患者），或按关键变量分层随机。
* **前瞻性采集**：在**治疗前**采集潜在混杂，保证时间顺序与完整性。

### 4.2 观察性数据的识别与估计（背门/PS 家族为主）

* **画 DAG**：列出你能想到的治疗前共同原因；
* **倾向评分（PS）**：PSM（匹配）、IPTW（加权）、PS 分层；
* **双重稳健（DR）/TMLE**：更稳健的现代方法；
* **标准化/G-computation**：直接建模 $P(Y\mid X,Z)$ 再标准化。
* **工具变量（IV）/前门**：当存在不可测混杂时的替代路径（假设更强）。

### 4.3 最小落地流程（建议贴在显示器上）

1. **明确时间线**：治疗前 vs 治疗后变量分清；
2. **变量角色判定**：混杂/中介/碰撞/修饰；
3. **建 PS，仅含治疗前混杂**，检查**重叠**与**平衡（SMD）**；
4. **估效应**：PSM/IPTW/DR/G-formula；
5. **敏感性分析**：极端权重截尾、替代模型、负控、E-value/未测混杂分析。

---

## 5）微型实验：看见“混杂导致方向颠倒”，再把它纠正

> 下例模拟“重症者更常用药、也更易死亡；但药物在真相里**降低**死亡”。
>
> * 天真比较/不调混杂 → **错把用药当致死**
> * 调整混杂（回归或 IPTW）→ **恢复药物的保护效应**

```python
import numpy as np, pandas as pd
from sklearn.linear_model import LogisticRegression
from sklearn.preprocessing import StandardScaler

np.random.seed(0)
n = 5000

# 混杂 Z：重症度（越高越重）
Z = np.clip(np.random.normal(0, 1, n), -2.5, 2.5)

# 治疗分配：Z 越高越可能被治疗（指征混杂）
logit_t = -0.2 + 1.2*Z
p_t = 1/(1+np.exp(-logit_t))
X = (np.random.rand(n) < p_t).astype(int)  # 1=治疗

# 真相：治疗有益（降低死亡），但重症本身提高死亡
logit_y = -2.0 + 1.1*Z - 0.8*X
p_y = 1/(1+np.exp(-logit_y))
Y = (np.random.rand(n) < p_y).astype(int)  # 1=死亡

df = pd.DataFrame({'Z':Z,'X':X,'Y':Y})

# 1) 天真比较：治疗组 vs 对照组死亡率差
naive_diff = df.loc[df.X==1,'Y'].mean() - df.loc[df.X==0,'Y'].mean()
print("天真比较：治疗组-对照组死亡率差 =", round(naive_diff, 3))

# 2) 回归调整：在logit(Y) ~ X + Z 中看 X 的系数方向
m_adj = LogisticRegression(max_iter=1000).fit(df[['X','Z']], df['Y'])
print("Logit回归中 X 的系数（<0 表示治疗保护）:", round(m_adj.coef_[0][0], 3))

# 3) IPTW：只用 Z 建 PS，并估计 ATE
scaler = StandardScaler()
ps = LogisticRegression(max_iter=1000).fit(scaler.fit_transform(df[['Z']]), df['X']).predict_proba(scaler.transform(df[['Z']]))[:,1]
w = np.where(df['X']==1, 1/ps, 1/(1-ps))
ate_iptw = (w[df.X==1]*df.Y[df.X==1]).sum()/w[df.X==1].sum() - (w[df.X==0]*df.Y[df.X==0]).sum()/w[df.X==0].sum()
print("IPTW 估计ATE（>0=增风险，<0=降风险）:", round(ate_iptw, 3))
```

**你会看到：**

* **天真比较**可能是“治疗组死亡率更高”（被混杂“骗了”）；
* **回归/IPTW**校正后，治疗效应变为**负值**（显示**保护**）。

---

## 6）再来一个 10 行小实验：碰撞偏倚是怎么“凭空造出关联”的？

```python
import numpy as np, pandas as pd
np.random.seed(1); n=100000

# X 与 U 互不相关
X = np.random.binomial(1, 0.5, n)
U = np.random.binomial(1, 0.5, n)

# A 是 X 与 U 的共同结果（碰撞）：只有 A=1 的人进入样本
A = (np.random.rand(n) < (0.05 + 0.4*X + 0.4*U)).astype(int)
keep = A==1

# 结局只受 U 影响（与 X 无关）
Y = U  # 为简单化

df = pd.DataFrame({'X':X[keep], 'U':U[keep], 'Y':Y[keep]})
print("总体上 X 与 Y 的相关性（应≈0）→", np.corrcoef(X, Y)[0,1])
print("筛选 A=1 后样本中 X 与 Y 的相关性（被碰撞打开）→", np.corrcoef(df.X, df.Y)[0,1])
```

**直观感受**：总体无关，**一旦条件化碰撞 A**，就会在样本里**凭空出现** X–Y 相关！

---

## 7）实操选变量：避免“过度/不足/错误调整”的 8 条原则

1. **只选治疗前变量**做混杂；
2. **优先选择共同原因**（会同向影响 X 与 Y），而非仅与 Y 强相关但与 X 无关的变量；
3. **不要把中介放进 PS/背门调整集**（估总效应时）；
4. **不要调整碰撞或碰撞的后代**；
5. **平衡可检验**（SMD/PS 重叠），但“充分控制混杂”是**基于假设与临床知识**；
6. **极端倾向要处理**（修剪/截尾/替代方法）；
7. **考虑时间窗口**：混杂信息取自治疗**之前**；
8. **做敏感性分析**：围绕未测混杂、不同建模、不同截尾阈值、负控结果进行稳健性检验。

---

## 8）快速复盘表

| 概念   | 识别要点     | 该不该调整    | 医学例子         |
| ---- | -------- | -------- | ------------ |
| 混杂   | 治疗前、共同原因 | ✅ 要      | 年龄、SOFA、合并症  |
| 中介   | X→M→Y    | ❌（估总效应时） | 用药→血压改善→死亡下降 |
| 碰撞   | X→A←U    | ❌ 不能     | 仅纳入“检查异常”的患者 |
| 效应修饰 | 效应随 W 变化 | ⚠️ 报异质性  | 老年与青年疗效不同    |

---

### 小结（给入门者的三句话）

1. **混杂是因果分析的第一敌人**：先画 DAG，先辨角色，再谈估计。
2. **偏倚种类多**：选择、测量、遗漏、时间相关……都可能让“相关看似因果”。
3. **流程要自带安全护栏**：时间线→变量角色→PS 平衡与重叠→效应估计→敏感性分析。

---

配套代码:`103_Confounding_Bias_MiniLabs.ipynb`

