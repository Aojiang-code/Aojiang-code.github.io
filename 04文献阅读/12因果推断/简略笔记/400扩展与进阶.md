# 📓 阶段 4 学习笔记 —— 扩展与进阶

## 🎯 学习目标

* 学会应对 **高维医学数据** 的因果推断
* 掌握 **机器学习方法** 在因果推断中的应用
* 初步理解 **深度学习因果模型** 和 **因果图像生成**

---

## 4.1 高维因果推断

### ① 为什么需要？

在医学研究中，现代数据往往是**高维**的：

* 基因组学（几万基因表达量）
* 影像组学（数千特征）
* 电子病历（数百实验室指标）

传统 PSM / IPTW 容易过拟合、失效，需要正则化或机器学习方法。

---

### ② LASSO + PSM

* **LASSO**（L1 正则化回归）可以帮助从高维特征中挑选重要的混杂因子。
* 在因果推断里 → **变量选择 + 倾向评分建模**。

Python 示例（选变量 + 倾向评分）：

```python
from sklearn.linear_model import LogisticRegressionCV
from sklearn.model_selection import train_test_split

X_train, X_test, T_train, T_test = train_test_split(X, T, test_size=0.3)

# L1 正则化（LASSO）
lasso_logit = LogisticRegressionCV(
    Cs=10, penalty="l1", solver="saga", cv=5, max_iter=5000
)
lasso_logit.fit(X_train, T_train)

selected_vars = X.columns[(lasso_logit.coef_ != 0).flatten()]
print("Selected confounders:", selected_vars)
```

---

### ③ Double Machine Learning (Double ML)

* 由 Chernozhukov 等提出
* 思路：用机器学习同时拟合 **治疗模型** 和 **结果模型**，再残差化，保证无偏。
* 特别适合 **高维数据**。

Python 可用 [`econml.dml.DMLCateEstimator`](https://econml.azurewebsites.net/spec/est.html)。

---

## 4.2 因果森林（Causal Forest）

### ① 思想

* 类似于随机森林，但每个树分裂时关注“治疗效应异质性”而不是预测误差。
* 能够直接输出 **个体化治疗效应 (ITE/CATE)**。

### ② 医学应用

* 精准医疗：判断某药物对 **特定亚组患者** 是否更有效。

### ③ Python 实现

在 `causalml` 里有 **CausalForest**：

```python
from causalml.inference.tree import CausalForest
from causalml.metrics import regression_metrics

cf = CausalForest()
cf.fit(X=X.values, treatment=T.values, y=Y.values)
ite = cf.predict(X.values)
print("Estimated ITE for first 5 patients:", ite[:5])
```

---

## 4.3 结合深度学习的因果推断

### ① DragonNet

* 基于 TensorFlow 的深度神经网络
* 一次性学到 **结果模型 + 倾向评分**
* 在医学影像和高维表型数据上表现好

> ⚠️ DragonNet 需要 TensorFlow/Keras，初学可先理解概念，后续再部署。

### ② DeepIV

* 处理 **工具变量 (IV)** 问题的深度学习方法
* 用神经网络拟合 IV 与治疗的关系，再建模治疗与结果

---

## 4.4 反事实图像生成

### ① 医学背景

* 在医学影像（CT/MRI/病理切片）中，我们常想问：

  > 如果患者没用药 / 换了治疗，影像会怎样变化？

### ② 方法

* 基于 **生成对抗网络 (GAN)** 或 **变分自编码器 (VAE)**
* 输入：真实影像 + 治疗信息
* 输出：反事实影像（模拟另一种治疗下的结果）

### ③ 应用

* 癌症病灶缩小的模拟 → 提前预测疗效
* 个体化治疗评估 → 让医生直观看到“如果换治疗”的结果

---

# ✅ 阶段 4 总结

1. **高维因果推断** → 用 LASSO 或 Double ML 处理多变量
2. **因果森林** → 捕捉个体化治疗效应，支持精准医疗
3. **深度学习方法**（DragonNet、DeepIV） → 适合复杂非线性场景
4. **反事实图像生成** → 医学影像中的新兴应用

---

把 **4.1（Double ML 高维推断）+ 4.2（因果森林）** 的 Python 最小可运行模板整理成一个 Notebook，直接放到下载区