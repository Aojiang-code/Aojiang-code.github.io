# 📓 阶段 3 学习笔记 —— 医学真实世界数据应用

## 🎯 学习目标

* 学会处理真实世界医学数据（大体量、复杂、缺失严重）
* 能用因果推断方法（PSM / IPTW）回答临床问题
* 掌握医学里常用的 **生存因果分析**（Cox + Kaplan-Meier）

---

## 3.1 MIMIC-IV ICU 数据因果推断

### ① 医学问题

真实场景：

> ICU 患者是否使用血管活性药物（vasopressor），会影响 **28 天死亡率** 吗？

这类问题在随机对照试验（RCT）中很难做 → 因为伦理和操作限制。
因此我们依赖 **MIMIC-IV** 这类 ICU 大型数据库，用 **观察性数据 + 因果推断方法** 逼近临床真实效应。

---

### ② 数据清洗流程

1. **选择研究人群**：

   * 成人 ICU 首次入院
   * 排除随访时间不足 28 天的病人

2. **变量选择**：

   * `treatment`: 是否使用血管活性药物
   * `outcome`: 28 天是否死亡（0/1）
   * `covariates`: 年龄、性别、SOFA 评分、合并症、实验室指标等

3. **缺失值处理**：

   * 连续变量 → 中位数填补
   * 分类变量 → 众数填补

4. **异常值处理**：Winsorization（极端值裁剪）

---

### ③ 构建因果图（DAG）

使用 `dagitty.net` 绘制：

```
Age  → Vasopressor
SOFA → Vasopressor
SOFA → Mortality
Comorbidity → Vasopressor
Comorbidity → Mortality
Vasopressor → Mortality
```

👉 **SOFA、合并症** 是典型混杂因素，需要调整。

---

### ④ Python 实现（PSM & IPTW）

示例（伪代码，实际需 MIMIC 数据表拼接）：

```python
import pandas as pd
from sklearn.linear_model import LogisticRegression
from sklearn.neighbors import NearestNeighbors
import matplotlib.pyplot as plt
import seaborn as sns

# 1. 倾向评分估计
X = df[["age","sofa","comorbidity_index"]]
T = df["vasopressor"]
Y = df["mortality_28d"]

logit = LogisticRegression(max_iter=1000)
logit.fit(X, T)
df["ps"] = logit.predict_proba(X)[:,1]

# 2. PSM 匹配
treated = df[df.T==1]
control = df[df.T==0]
nn = NearestNeighbors(n_neighbors=1).fit(control[["ps"]])
_, idx = nn.kneighbors(treated[["ps"]])
matched = pd.concat([treated, control.iloc[idx.flatten()]])

# 3. IPTW
df["weight"] = df.T/df.ps + (1-df.T)/(1-df.ps)

# 4. 结果比较
print("PSM 组间死亡率差异：", matched.groupby("T")["mortality_28d"].mean())
print("IPTW 加权死亡率差异：", (df["mortality_28d"]*df["weight"]).groupby(df["T"]).mean())
```

---

### ⑤ 临床解释

* **PSM** → “在基线特征相似的患者中，使用血管活性药物 vs 未使用的死亡率差异”
* **IPTW** → “在加权后构造的伪随机化人群中，药物使用对死亡率的平均效应”

---

## 3.2 生存数据因果推断

### ① 医学问题

使用 **SEER 癌症数据库**，研究：

> 接受化疗（treatment=1）的患者，是否能显著延长生存期？

---

### ② 方法：IPTW + Cox 回归

1. **因果建模**

   * 先用 IPTW 调整基线差异
   * 再在加权数据上拟合 Cox 回归
   * 检查 **加权 Kaplan-Meier 曲线**

2. **核心思想**

   * IPTW 构造平衡人群
   * Cox 回归提供 HR（风险比），解释为“治疗降低死亡风险的倍数”

---

### ③ Python 实现

```python
from sklearn.linear_model import LogisticRegression
import numpy as np
import pandas as pd
from lifelines import CoxPHFitter, KaplanMeierFitter

# 假设 df 有: ["time","event","treatment","age","stage","sex"]

# 1. 倾向评分
X = df[["age","stage","sex"]]
T = df["treatment"]
logit = LogisticRegression(max_iter=1000)
logit.fit(X,T)
df["ps"] = logit.predict_proba(X)[:,1]

# 2. IPTW 权重
df["weight"] = df.T/df.ps + (1-df.T)/(1-df.ps)

# 3. 加权 Cox 回归
cph = CoxPHFitter()
cph.fit(df, duration_col="time", event_col="event", weights_col="weight")
cph.print_summary()

# 4. 加权 KM 曲线
kmf = KaplanMeierFitter()
for t in [0,1]:
    mask = df["treatment"]==t
    kmf.fit(df.loc[mask,"time"], df.loc[mask,"event"], weights=df.loc[mask,"weight"], label=f"treatment={t}")
    kmf.plot_survival_function()
```

---

### ④ 结果解释

* **HR < 1**：化疗显著降低死亡风险
* **KM 曲线分离**：说明治疗组和对照组生存率差异有临床意义

---

# ✅ 阶段 3 总结

1. **MIMIC-IV** → ICU 药物因果效应（PSM/IPTW）
2. **SEER** → 癌症生存因果效应（IPTW + Cox + KM 曲线）
3. 关键在于：

   * 数据清洗 & 缺失值处理
   * 构建 DAG 明确混杂
   * 合理解释医学意义

---

把 **3.1 (MIMIC-IV ICU)** 和 **3.2 (SEER 生存分析)** 的 Python 模板整理成两个 Notebook，放到下载区
