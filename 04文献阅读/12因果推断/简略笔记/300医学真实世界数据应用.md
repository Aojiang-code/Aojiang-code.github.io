# ğŸ““ é˜¶æ®µ 3 å­¦ä¹ ç¬”è®° â€”â€” åŒ»å­¦çœŸå®ä¸–ç•Œæ•°æ®åº”ç”¨

## ğŸ¯ å­¦ä¹ ç›®æ ‡

* å­¦ä¼šå¤„ç†çœŸå®ä¸–ç•ŒåŒ»å­¦æ•°æ®ï¼ˆå¤§ä½“é‡ã€å¤æ‚ã€ç¼ºå¤±ä¸¥é‡ï¼‰
* èƒ½ç”¨å› æœæ¨æ–­æ–¹æ³•ï¼ˆPSM / IPTWï¼‰å›ç­”ä¸´åºŠé—®é¢˜
* æŒæ¡åŒ»å­¦é‡Œå¸¸ç”¨çš„ **ç”Ÿå­˜å› æœåˆ†æ**ï¼ˆCox + Kaplan-Meierï¼‰

---

## 3.1 MIMIC-IV ICU æ•°æ®å› æœæ¨æ–­

### â‘  åŒ»å­¦é—®é¢˜

çœŸå®åœºæ™¯ï¼š

> ICU æ‚£è€…æ˜¯å¦ä½¿ç”¨è¡€ç®¡æ´»æ€§è¯ç‰©ï¼ˆvasopressorï¼‰ï¼Œä¼šå½±å“ **28 å¤©æ­»äº¡ç‡** å—ï¼Ÿ

è¿™ç±»é—®é¢˜åœ¨éšæœºå¯¹ç…§è¯•éªŒï¼ˆRCTï¼‰ä¸­å¾ˆéš¾åš â†’ å› ä¸ºä¼¦ç†å’Œæ“ä½œé™åˆ¶ã€‚
å› æ­¤æˆ‘ä»¬ä¾èµ– **MIMIC-IV** è¿™ç±» ICU å¤§å‹æ•°æ®åº“ï¼Œç”¨ **è§‚å¯Ÿæ€§æ•°æ® + å› æœæ¨æ–­æ–¹æ³•** é€¼è¿‘ä¸´åºŠçœŸå®æ•ˆåº”ã€‚

---

### â‘¡ æ•°æ®æ¸…æ´—æµç¨‹

1. **é€‰æ‹©ç ”ç©¶äººç¾¤**ï¼š

   * æˆäºº ICU é¦–æ¬¡å…¥é™¢
   * æ’é™¤éšè®¿æ—¶é—´ä¸è¶³ 28 å¤©çš„ç—…äºº

2. **å˜é‡é€‰æ‹©**ï¼š

   * `treatment`: æ˜¯å¦ä½¿ç”¨è¡€ç®¡æ´»æ€§è¯ç‰©
   * `outcome`: 28 å¤©æ˜¯å¦æ­»äº¡ï¼ˆ0/1ï¼‰
   * `covariates`: å¹´é¾„ã€æ€§åˆ«ã€SOFA è¯„åˆ†ã€åˆå¹¶ç—‡ã€å®éªŒå®¤æŒ‡æ ‡ç­‰

3. **ç¼ºå¤±å€¼å¤„ç†**ï¼š

   * è¿ç»­å˜é‡ â†’ ä¸­ä½æ•°å¡«è¡¥
   * åˆ†ç±»å˜é‡ â†’ ä¼—æ•°å¡«è¡¥

4. **å¼‚å¸¸å€¼å¤„ç†**ï¼šWinsorizationï¼ˆæç«¯å€¼è£å‰ªï¼‰

---

### â‘¢ æ„å»ºå› æœå›¾ï¼ˆDAGï¼‰

ä½¿ç”¨ `dagitty.net` ç»˜åˆ¶ï¼š

```
Age  â†’ Vasopressor
SOFA â†’ Vasopressor
SOFA â†’ Mortality
Comorbidity â†’ Vasopressor
Comorbidity â†’ Mortality
Vasopressor â†’ Mortality
```

ğŸ‘‰ **SOFAã€åˆå¹¶ç—‡** æ˜¯å…¸å‹æ··æ‚å› ç´ ï¼Œéœ€è¦è°ƒæ•´ã€‚

---

### â‘£ Python å®ç°ï¼ˆPSM & IPTWï¼‰

ç¤ºä¾‹ï¼ˆä¼ªä»£ç ï¼Œå®é™…éœ€ MIMIC æ•°æ®è¡¨æ‹¼æ¥ï¼‰ï¼š

```python
import pandas as pd
from sklearn.linear_model import LogisticRegression
from sklearn.neighbors import NearestNeighbors
import matplotlib.pyplot as plt
import seaborn as sns

# 1. å€¾å‘è¯„åˆ†ä¼°è®¡
X = df[["age","sofa","comorbidity_index"]]
T = df["vasopressor"]
Y = df["mortality_28d"]

logit = LogisticRegression(max_iter=1000)
logit.fit(X, T)
df["ps"] = logit.predict_proba(X)[:,1]

# 2. PSM åŒ¹é…
treated = df[df.T==1]
control = df[df.T==0]
nn = NearestNeighbors(n_neighbors=1).fit(control[["ps"]])
_, idx = nn.kneighbors(treated[["ps"]])
matched = pd.concat([treated, control.iloc[idx.flatten()]])

# 3. IPTW
df["weight"] = df.T/df.ps + (1-df.T)/(1-df.ps)

# 4. ç»“æœæ¯”è¾ƒ
print("PSM ç»„é—´æ­»äº¡ç‡å·®å¼‚ï¼š", matched.groupby("T")["mortality_28d"].mean())
print("IPTW åŠ æƒæ­»äº¡ç‡å·®å¼‚ï¼š", (df["mortality_28d"]*df["weight"]).groupby(df["T"]).mean())
```

---

### â‘¤ ä¸´åºŠè§£é‡Š

* **PSM** â†’ â€œåœ¨åŸºçº¿ç‰¹å¾ç›¸ä¼¼çš„æ‚£è€…ä¸­ï¼Œä½¿ç”¨è¡€ç®¡æ´»æ€§è¯ç‰© vs æœªä½¿ç”¨çš„æ­»äº¡ç‡å·®å¼‚â€
* **IPTW** â†’ â€œåœ¨åŠ æƒåæ„é€ çš„ä¼ªéšæœºåŒ–äººç¾¤ä¸­ï¼Œè¯ç‰©ä½¿ç”¨å¯¹æ­»äº¡ç‡çš„å¹³å‡æ•ˆåº”â€

---

## 3.2 ç”Ÿå­˜æ•°æ®å› æœæ¨æ–­

### â‘  åŒ»å­¦é—®é¢˜

ä½¿ç”¨ **SEER ç™Œç—‡æ•°æ®åº“**ï¼Œç ”ç©¶ï¼š

> æ¥å—åŒ–ç–—ï¼ˆtreatment=1ï¼‰çš„æ‚£è€…ï¼Œæ˜¯å¦èƒ½æ˜¾è‘—å»¶é•¿ç”Ÿå­˜æœŸï¼Ÿ

---

### â‘¡ æ–¹æ³•ï¼šIPTW + Cox å›å½’

1. **å› æœå»ºæ¨¡**

   * å…ˆç”¨ IPTW è°ƒæ•´åŸºçº¿å·®å¼‚
   * å†åœ¨åŠ æƒæ•°æ®ä¸Šæ‹Ÿåˆ Cox å›å½’
   * æ£€æŸ¥ **åŠ æƒ Kaplan-Meier æ›²çº¿**

2. **æ ¸å¿ƒæ€æƒ³**

   * IPTW æ„é€ å¹³è¡¡äººç¾¤
   * Cox å›å½’æä¾› HRï¼ˆé£é™©æ¯”ï¼‰ï¼Œè§£é‡Šä¸ºâ€œæ²»ç–—é™ä½æ­»äº¡é£é™©çš„å€æ•°â€

---

### â‘¢ Python å®ç°

```python
from sklearn.linear_model import LogisticRegression
import numpy as np
import pandas as pd
from lifelines import CoxPHFitter, KaplanMeierFitter

# å‡è®¾ df æœ‰: ["time","event","treatment","age","stage","sex"]

# 1. å€¾å‘è¯„åˆ†
X = df[["age","stage","sex"]]
T = df["treatment"]
logit = LogisticRegression(max_iter=1000)
logit.fit(X,T)
df["ps"] = logit.predict_proba(X)[:,1]

# 2. IPTW æƒé‡
df["weight"] = df.T/df.ps + (1-df.T)/(1-df.ps)

# 3. åŠ æƒ Cox å›å½’
cph = CoxPHFitter()
cph.fit(df, duration_col="time", event_col="event", weights_col="weight")
cph.print_summary()

# 4. åŠ æƒ KM æ›²çº¿
kmf = KaplanMeierFitter()
for t in [0,1]:
    mask = df["treatment"]==t
    kmf.fit(df.loc[mask,"time"], df.loc[mask,"event"], weights=df.loc[mask,"weight"], label=f"treatment={t}")
    kmf.plot_survival_function()
```

---

### â‘£ ç»“æœè§£é‡Š

* **HR < 1**ï¼šåŒ–ç–—æ˜¾è‘—é™ä½æ­»äº¡é£é™©
* **KM æ›²çº¿åˆ†ç¦»**ï¼šè¯´æ˜æ²»ç–—ç»„å’Œå¯¹ç…§ç»„ç”Ÿå­˜ç‡å·®å¼‚æœ‰ä¸´åºŠæ„ä¹‰

---

# âœ… é˜¶æ®µ 3 æ€»ç»“

1. **MIMIC-IV** â†’ ICU è¯ç‰©å› æœæ•ˆåº”ï¼ˆPSM/IPTWï¼‰
2. **SEER** â†’ ç™Œç—‡ç”Ÿå­˜å› æœæ•ˆåº”ï¼ˆIPTW + Cox + KM æ›²çº¿ï¼‰
3. å…³é”®åœ¨äºï¼š

   * æ•°æ®æ¸…æ´— & ç¼ºå¤±å€¼å¤„ç†
   * æ„å»º DAG æ˜ç¡®æ··æ‚
   * åˆç†è§£é‡ŠåŒ»å­¦æ„ä¹‰

---

æŠŠ **3.1 (MIMIC-IV ICU)** å’Œ **3.2 (SEER ç”Ÿå­˜åˆ†æ)** çš„ Python æ¨¡æ¿æ•´ç†æˆä¸¤ä¸ª Notebookï¼Œæ”¾åˆ°ä¸‹è½½åŒº
