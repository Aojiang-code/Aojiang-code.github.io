éå¸¸å¥½ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¿›å…¥ï¼š

---

# ğŸ“ ç¬¬äºŒé˜¶æ®µï¼šæ„å»º AKI æ ‡ç­¾ ä¸ æå– 24å°æ—¶å†…ç‰¹å¾ï¼ˆåŸºäº MIMIC-IVï¼‰

---

## ğŸ¯ ç›®æ ‡ï¼š

1. ä½¿ç”¨ **KDIGO æ ‡å‡†** æ ¹æ®è‚Œé…å’Œå°¿é‡åˆ¤æ–­ ICU ä½é™¢ 7 å¤©å†…æ˜¯å¦å‘ç”Ÿ AKIï¼›
2. æå–å…¥ ICU å **å‰ 24 å°æ—¶**çš„å®éªŒå®¤æŒ‡æ ‡ï¼ˆBUNã€Scrã€PLTã€GLU ç­‰ï¼‰å’Œå°¿é‡ç­‰ç‰¹å¾ã€‚

---

## ğŸ§© æ•°æ®è¦æ±‚ï¼š

ä½ åº”å·²åŠ è½½ï¼š

| è¡¨å                | ç”¨é€”                       |
| ----------------- | ------------------------ |
| `labevents.csv`   | è·å– BUNã€Scrã€GLU ç­‰å®éªŒå®¤æ•°æ®    |
| `chartevents.csv` | è·å– HRã€RRã€å°¿é‡ã€è¡€å‹ã€GCS ç­‰åŠ¨æ€ç‰¹å¾ |

> ğŸ”§ æ³¨æ„ï¼šMIMIC-IV v2.2 ä¸­ `chartevents` å’Œ `labevents` åˆ†å¸ƒåœ¨ `mimiciv_icu` å’Œ `mimiciv_hosp` ç›®å½•ä¸‹ï¼Œå¦‚æœä½ æ˜¯ CSV ç‰ˆï¼Œå®ƒä»¬éƒ½æ˜¯æ–‡ä»¶ã€‚

---

## ğŸ“˜ Step 1ï¼šåŠ è½½æ•°æ®ï¼ˆå¦‚æœæœªåŠ è½½ï¼‰

```python
labevents = pd.read_csv("mimiciv/labevents.csv")
chartevents = pd.read_csv("mimiciv/chartevents.csv")
```

---

## ğŸ“˜ Step 2ï¼šå®šä¹‰ AKI æ ‡ç­¾ï¼ˆåŸºäº KDIGOï¼‰

### ğŸ” AKIåˆ¤å®šé€»è¾‘ï¼š

* Serum Creatinineï¼ˆScrï¼‰å‡é«˜ â‰¥ 0.3 mg/dL within 48hï¼›
* æˆ– â‰¥ 1.5Ã— baseline within 7 daysï¼›
* æˆ– 24hå°¿é‡ < 0.5 mL/kg/hï¼›

---

## âœ… 2.1 æå– Scr æ•°æ®ï¼ˆCreatinineï¼‰

```python
# Creatinine ITEMIDï¼ˆé€šå¸¸ä¸º 50912ï¼‰ğŸ‘‰ è¯·æ›¿æ¢ä¸ºä½ çš„MIMIC-IVä¸­çœŸå®ID
SCR_ITEMID = 50912

scr_data = labevents[
    (labevents['itemid'] == SCR_ITEMID) &
    (labevents['stay_id'].isin(dka_df['stay_id']))
]

# åˆå¹¶å…¥ICUæ—¶é—´ç”¨äºè®¡ç®—æ—¶é—´çª—
scr_data = scr_data.merge(
    dka_df[['stay_id', 'intime']],
    on='stay_id', how='left'
)

scr_data['charttime'] = pd.to_datetime(scr_data['charttime'])
scr_data['intime'] = pd.to_datetime(scr_data['intime'])

# è®¡ç®—ä¸ICUå…¥ç»„æ—¶é—´å·®ï¼ˆä»¥å°æ—¶è®¡ï¼‰
scr_data['hours_from_icu'] = (scr_data['charttime'] - scr_data['intime']).dt.total_seconds() / 3600
```

---

## âœ… 2.2 æ„å»º AKI æ ‡ç­¾ï¼ˆç®€åŒ–ç‰ˆï¼‰

```python
# é€‰å– ICU å7å¤©å†…çš„Scrè®°å½•
scr_7d = scr_data[scr_data['hours_from_icu'] <= 24 * 7]

# æ‰¾å‡ºæ¯ä¸ªstay_idçš„åŸºçº¿Scrï¼ˆICUå‰24å°æ—¶æˆ–é¦–æ¬¡æµ‹å¾—ï¼‰
baseline_scr = scr_7d.groupby('stay_id')['valuenum'].min().rename('baseline_scr')
max_scr = scr_7d.groupby('stay_id')['valuenum'].max().rename('max_scr')

aki_flag = (max_scr / baseline_scr >= 1.5) | ((max_scr - baseline_scr) >= 0.3)

# åˆå¹¶æˆæ ‡ç­¾
aki_label = aki_flag.astype(int).rename('AKI')
```

> âœ… æ­¤æ ‡ç­¾ä¸ºç®€åŒ–å®ç°çš„ KDIGO æ ‡ç­¾ï¼›åç»­å¯æ·»åŠ å°¿é‡è”åˆåˆ¤æ–­ï¼ˆè§ä¸‹æ–¹æ‰©å±•ï¼‰

---

## ğŸ“˜ Step 3ï¼šæå–å®éªŒå®¤ç‰¹å¾ï¼ˆå‰24å°æ—¶ï¼‰

### âœ³ï¸ å¸¸ç”¨ lab é¡¹ç›® IDï¼ˆä»¥ MIMIC-IV ä¸ºä¾‹ï¼‰ï¼š

| é¡¹ç›®              | itemidï¼ˆå¯èƒ½ï¼‰ |
| --------------- | ---------- |
| BUN             | 51006      |
| Creatinine      | 50912      |
| Glucose         | 50931      |
| Platelets (PLT) | 51265      |
| Sodium          | 50983      |
| Potassium       | 50971      |
| WBC             | 51301      |
| Hemoglobin      | 51222      |

```python
lab_items = {
    'BUN': 51006,
    'Scr': 50912,
    'GLU': 50931,
    'PLT': 51265,
    'Na': 50983,
    'K': 50971,
    'WBC': 51301,
    'Hb': 51222
}

lab_24h = labevents[
    (labevents['itemid'].isin(lab_items.values())) &
    (labevents['stay_id'].isin(dka_df['stay_id']))
].merge(dka_df[['stay_id', 'intime']], on='stay_id')

lab_24h['charttime'] = pd.to_datetime(lab_24h['charttime'])
lab_24h['intime'] = pd.to_datetime(lab_24h['intime'])
lab_24h['hours_from_icu'] = (lab_24h['charttime'] - lab_24h['intime']).dt.total_seconds() / 3600

lab_24h = lab_24h[lab_24h['hours_from_icu'] <= 24]
```

### ğŸ”„ è½¬æ¢ä¸ºæ¯ä¸ª stay\_id ä¸€è¡Œçš„ç‰¹å¾è¡¨ï¼š

```python
# pivot + agg
lab_feature_df = (
    lab_24h
    .groupby(['stay_id', 'itemid'])['valuenum']
    .median()
    .unstack()
    .rename(columns={v: k for k, v in lab_items.items()})
)
```

---

## ğŸ“˜ Step 4ï¼ˆå¯é€‰ï¼‰ï¼šæå–å°¿é‡ï¼ˆcharteventsï¼‰

```python
# å°¿é‡ itemid åˆ—è¡¨ï¼ˆå¤šä¸ªé¡¹åˆå¹¶ï¼‰ï¼šâ€˜UOâ€™ ç±»
urine_itemids = [226559, 226560, 226561, 226584]

urine_df = chartevents[
    (chartevents['itemid'].isin(urine_itemids)) &
    (chartevents['stay_id'].isin(dka_df['stay_id']))
].merge(dka_df[['stay_id', 'intime']], on='stay_id')

urine_df['charttime'] = pd.to_datetime(urine_df['charttime'])
urine_df['intime'] = pd.to_datetime(urine_df['intime'])
urine_df['hours_from_icu'] = (urine_df['charttime'] - urine_df['intime']).dt.total_seconds() / 3600

# ä»…å‰24å°æ—¶
urine_24h = urine_df[urine_df['hours_from_icu'] <= 24]

urine_volume = urine_24h.groupby('stay_id')['valuenum'].sum().rename('urine_24h_total')
```

---

## ğŸ“˜ Step 5ï¼šåˆå¹¶æ ‡ç­¾ + ç‰¹å¾

```python
# åˆå¹¶æ‰€æœ‰ä¿¡æ¯
final_df = (
    dka_df
    .set_index('stay_id')
    .join(lab_feature_df)
    .join(urine_volume)
    .join(aki_label)
)

# æŸ¥çœ‹å‰å‡ è¡Œ
final_df.head()
```

---

## âœ… é˜¶æ®µè¾“å‡ºè¯´æ˜ï¼š

| è¾“å‡ºå˜é‡å                      | è¯´æ˜                                            |
| -------------------------- | --------------------------------------------- |
| `final_df`                 | åŒ…å« DKA æ‚£è€…çš„ ICU stay\_idã€äººå£å­¦å˜é‡ã€å‰24å°æ—¶ç‰¹å¾å’Œ AKI æ ‡ç­¾ |
| è¡Œæ•° â‰ˆ dka\_df è¡Œæ•°ï¼ˆæœ‰å°‘é‡æ•°æ®ç¼ºå¤±å¯èƒ½ï¼‰ |                                               |
| åç»­å¯å¯¹è¯¥è¡¨è¿›è¡Œå»ºæ¨¡è®­ç»ƒ               |                                               |

---

æ˜¯å¦ç°åœ¨ç»§ç»­è¿›å…¥ **ç¬¬ä¸‰é˜¶æ®µï¼šç‰¹å¾å·¥ç¨‹ä¸è®­ç»ƒé›†æ„å»º**ï¼Ÿæˆ‘å¯ä»¥å¸®æ‚¨æ„é€ å®Œæ•´è®­ç»ƒé›†å¹¶å¼€å§‹æ¨¡å‹å¼€å‘ã€‚
