给你打包好了一整套“可直接运行”的复现工程（含配置、SQL、特征抽取、KDIGO标签、建模、校准曲线与DCA、评估与出图）👇


## 你要做的最少改动

1. 安装依赖（建议新建虚拟环境）

```bash
conda create -n mimic-repro python=3.10 -y
conda activate mimic-repro
pip install -r requirements.txt
```

2. 编辑 `conf/config.yaml`：把 `paths.mimic_root` 改成你本地的 **MIMIC-IV** 数据根目录（支持 CSV/CSV.GZ/Parquet），或改为 Postgres 连接。

3. 一键跑全流程：

```bash
python -m src.run_all --config conf/config.yaml
```

## 工程里都有什么

* `sql/cohort.sql`：按 ICD-9/10 的 DKA 代码集筛出 **成人、首个 ICU** 的队列。
* `codesets/icd_dka_codes.csv`：我已内置了常用 DKA 代码表（ICD-9/10）；如需更严/更宽，可直接在 CSV 里增删。
* `src/labels_kdigo.py`：落地 **KDIGO**（Scr 两条 + 尿量 6h 窗）计算 **7天内 AKI**。
* `src/features.py`：从 ICU 入科后 **0–24h** 抽取首检/汇总特征（BUN、尿量、体重、年龄、血小板、葡萄糖、24h 输入量等），并按“>20% 缺失剔除、其余后续插补”策略处理。
* `src/train.py`：**LASSO（LogReg L1）** 做特征筛选 → **XGBoost** 主模型（可切 LightGBM/LogReg），并用 **isotonic** 做概率校准；85/15 随机切分 + 训练内 **10 折 CV**。
* `src/eval.py` + `src/plotting_calibration.py` + `src/plotting_dca.py`：输出 AUC、AUPRC、Brier、ECE、敏感度、特异度、准确度，以及 **ROC/PR**、**校准曲线（含95%CI）**、**DCA** 图。
* `src/data_source.py`：统一的数据读取接口。**DuckDB 模式**会自动将 `hosp/*.csv[.gz]|*.parquet`、`icu/*.csv[.gz]|*.parquet` 映射为表；也支持 **Postgres**（可在 `data_source` 切换）。
* 产物路径：

  * 中间数据：`data/interim/*.parquet`
  * 特征/标签：`data/processed/features.parquet`, `labels.parquet`
  * 模型与特征子集：`data/models/*`
  * 指标与图：`outputs/reports/*.json`, `outputs/plots/*.png`

## 与原文的一致性（关键对齐点）

* 队列：**DKA（ICD-9/10）** + 成人 + **首个 ICU**。
* 观察窗：**0–24h** 内特征（首检/总量）；
* 结局窗：**0–7d** 内 AKI（KDIGO：Scr 0.3/48h 或 1.5×/7d；尿量 <0.5 mL/kg/h 持续≥6h）。
* 建模：**LASSO→XGBoost**，训练内 **10-fold CV**；外部验证为 85/15 随机切分的 held-out。
* 评估：AUC/敏感度/特异度/准确度 + **AUPRC、Brier、ECE**；**校准曲线**与 **DCA** 一步到位。

## 常见环境/数据注意点

* `icu.chartevents` 非常大：我已按 **item 名称模式**只检索“体重/生命体征”等相关项；DuckDB 读取 Parquet 会更快。
* 单位与同义词：我在 `features.py` 里用正则模式（如 `urea|bun|blood urea`, `platelet|plt`）自动匹配 `d_labitems`，减少手填 `itemid` 的漏/错。若你已有固定 itemid 清单，可直接替换为硬编码列表。
* 尿量按小时汇总后做 **6h 滚动**判断；体重取 ICU 入科前后最近值用于 mL/kg/h 折算。
* “>20% 缺失剔除”后，模型训练阶段会再做标准化与 L1 选择；如需 **KNN 插补**，可在 `train.py` 里加上 Imputer（我这里遵循你大纲，保留在特征阶段剔除、建模阶段由 LASSO 和校准适配）。

---

如果你愿意，我也可以把你上传的分阶段 notebook（0100–0600）要点合并进这套 CLI 流程，让你既能 **一键跑全流程**，又保留 **阶段化可视化** 的 notebook 版本。你先按上面三步跑起来；跑通后，把 `outputs/reports/metrics_val.json` 的结果贴给我，我再帮你对比原文的 AUC/重要特征排序，并做必要的微调（比如 creatinine 基线定义、尿量窗口、或 XGBoost 超参）。
