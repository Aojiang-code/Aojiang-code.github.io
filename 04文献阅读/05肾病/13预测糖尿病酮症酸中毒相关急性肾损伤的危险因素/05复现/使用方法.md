## 里面都有什么

* `00_config.yaml`：把**时间窗、KDIGO规则、缺失处理、分组划分**、候选特征等都集中配置。
* `configs/mimic_ids.yaml`：**DKA ICD-9/10** 和 **itemid 列表**的集中配置（目前放了占位符，你只需替换为本地的编码与 itemid）。
* `src/01_extract_duckdb.sql` + `01_extract_duckdb.py`：用 DuckDB 从 MIMIC CSV 里抽取 **DKA 首次 ICU** 人群，并构造**入科 24h 首测值/汇总**（BUN、Scr、尿量、体重、生命体征、葡萄糖、补液量等）。
* `src/02_make_labels.py`：**KDIGO-AKI 7天** 标签生成（支持三种基线 SCr 规则；实现了 0.3 mg/dL/48h & 1.5×/7d 以及**尿量滚动窗口**<0.5 ml/kg/h ≥6h 的逻辑）。
* `src/03_features_24h.py`：按**缺失阈值**（默认20%）剔除变量，产出建模表。
* `src/04_train_eval.py`：**85/15 分组划分（subject\_id）**、泄漏安全的 `Pipeline`（KNN 插补/标准化/独热）、**LASSO 预筛（代理）**、多模型（LogReg/SVM/AdaBoost/MLP/可选 XGBoost）、**AUC/PR-AUC/灵敏度/特异度/F1/Brier**、**Youden J** 自动阈值；同时导出 **DCA** 数据。
* `src/05_calibration_dca.py`：校准/DCA 结果聚合（核心计算已在 04 内输出）。
* `src/06_shap_pdp.py`：XGBoost 的 **SHAP 特征重要性**与 PDP 支撑（保存 `feature_importance.json`）。
* `scripts/run_all.sh`：一键跑完全流程。
* `requirements.txt`：环境依赖（scikit-learn≥1.4，xgboost、duckdb、pyarrow、shap 等）。

## 你需要做的最少改动（3 步）

1. 打开 `00_config.yaml`，把 `paths.mimic_csv_dir` 指向你的 MIMIC-IV CSV 根目录。
2. 打开 `configs/mimic_ids.yaml`，把 **DKA ICD** 与 **itemid** 列表补全（注：目前是示例/占位，需替换为你本地的编码）。
3. 终端执行：

```bash
python -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt
bash scripts/run_all.sh
```

## 已特别处理的关键点

* **防泄漏**：所有预处理（KNN 插补、标准化、独热）都在 `Pipeline` 内，仅对训练集拟合。
* **分组划分**：`GroupShuffleSplit` 按 `subject_id` 做 85/15，避免同一患者进不同集合。
* **KDIGO 可配置**：提供三种**基线 SCr**策略；尿量用**逐小时滚动窗口**逼近“连续≥6小时”标准。
* **可比性**：默认保留 `scr_first24h`、`bun`、`urine_24h`、`weight`、`age`、`plt`、`glucose` 等变量，LASSO 目标数默认 7（你可按论文候选集微调）。
* **可解释性**：导出 **DCA** 曲线数据与 **SHAP** 排名，便于复现“BUN、尿量、体重、年龄、PLT”居前的结论。

如果你把 **ICD & itemid** 列表（或者 MIMIC 的 d\_items/d\_labitems 对照表）发给我，我可以**帮你直接把两个 YAML 填好**，并把 `01_extract_duckdb.sql` 中的选择器对齐到你本地版本。另外，如果你希望把**校准曲线**和 **DCA** 画图脚本也加上（matplotlib 版本），我也可以补上可视化模板。
