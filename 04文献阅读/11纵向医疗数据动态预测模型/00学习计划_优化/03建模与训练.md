éå¸¸å¥½ï¼Œä»¥ä¸‹æ˜¯å®Œæ•´çš„ **ç¬¬ä¸‰é˜¶æ®µï¼šå»ºæ¨¡ä¸è®­ç»ƒï¼ˆæ¨¡å‹æ„å»º + ä»»åŠ¡å®šä¹‰ + Trainer è®­ç»ƒï¼‰** å®æ“å­¦ä¹ è®¡åˆ’ï¼Œé‡ç‚¹æ˜¯å°†ä½ åœ¨ä¸Šä¸€é˜¶æ®µæ„é€ çš„ MIMIC-AKI æ•°æ®é›†è½¬ä¸ºå¯è®­ç»ƒæ ¼å¼ï¼Œè¿è¡Œè‡³å°‘ä¸€ä¸ªé¢„æµ‹æ¨¡å‹ï¼ˆå¦‚ GRU-Dï¼‰å¹¶å®Œæˆè®­ç»ƒä¸è¯„ä¼°æµç¨‹ã€‚

---

# ğŸ§  ç¬¬ä¸‰é˜¶æ®µï¼šå»ºæ¨¡ä¸è®­ç»ƒï¼ˆPyHealth for MIMIC-AKIï¼‰

---

## ğŸ¯ é˜¶æ®µç›®æ ‡

1. å°† AKI\_LAB æ•°æ®é›†è®¾ç½®ä¸ºäºŒåˆ†ç±»é¢„æµ‹ä»»åŠ¡ï¼›
2. æ„å»ºåˆé€‚çš„æ¨¡å‹ï¼ˆå¦‚ GRU-Dã€RETAINï¼‰ï¼›
3. åˆ’åˆ†è®­ç»ƒé›†/éªŒè¯é›†/æµ‹è¯•é›†ï¼Œè®¾ç½® Dataloaderï¼›
4. å®Œæˆè®­ç»ƒã€EarlyStopping å’Œæ¨¡å‹ä¿å­˜ï¼›
5. å®Œæˆæµ‹è¯•è¯„ä¼°å¹¶æ‰“å°å¤šé¡¹æŒ‡æ ‡ï¼ˆAUCã€F1ã€Accuracyï¼‰ã€‚

---

## â± æ¨èç”¨æ—¶ï¼š1â€“2 å¤©

---

## âœ… æ­¥éª¤ä¸€ï¼šå®šä¹‰ä»»åŠ¡

ä»¥ **æœªæ¥7å¤©æ˜¯å¦å‘ç”Ÿ AKI** ä¸ºäºŒåˆ†ç±»ç›®æ ‡ï¼š

```python
from pyhealth.tasks import BinaryPredictionTask

aki_task = BinaryPredictionTask(
    dataset=custom_dataset,         # ä¸Šä¸€é˜¶æ®µç”Ÿæˆçš„ dataset
    event_type="lab",               # ä½¿ç”¨å®éªŒå®¤äº‹ä»¶ä½œä¸ºè¾“å…¥
    label_key="aki",                # æ¥è‡ª Event attr_dict
    time_window=7,                  # è®¾ç½®é¢„æµ‹æ—¶é—´çª—å£ï¼ˆå¯è‡ªè°ƒï¼‰
    use_time=True,
    use_visit=True
)

processed_dataset = custom_dataset.set_task(aki_task)
```

---

## âœ… æ­¥éª¤äºŒï¼šåˆ’åˆ†è®­ç»ƒé›† / éªŒè¯é›† / æµ‹è¯•é›†

```python
from pyhealth.datasets import split_by_patient

train_ds, val_ds, test_ds = split_by_patient(processed_dataset, [0.7, 0.15, 0.15])
```

---

## âœ… æ­¥éª¤ä¸‰ï¼šåˆ›å»º Dataloader

```python
from pyhealth.datasets import get_dataloader

train_loader = get_dataloader(train_ds, batch_size=64, shuffle=True)
val_loader = get_dataloader(val_ds, batch_size=64)
test_loader = get_dataloader(test_ds, batch_size=64)
```

---

## âœ… æ­¥éª¤å››ï¼šæ„å»ºæ¨¡å‹ï¼ˆæ¨è GRU-Dï¼‰

```python
from pyhealth.models import GRUD

model = GRUD(dataset=processed_dataset)  # ä¸€å®šè¦ç”¨ set_task åçš„ dataset æ„é€ 
```

å…¶ä»–å¤‡é€‰æ¨¡å‹ï¼š

```python
from pyhealth.models import RETAIN, Transformer

model = RETAIN(dataset=processed_dataset)
# model = Transformer(dataset=processed_dataset)
```

---

## âœ… æ­¥éª¤äº”ï¼šè®­ç»ƒæ¨¡å‹

```python
from pyhealth.trainer import Trainer

trainer = Trainer(
    model=model,
    metrics=["auc", "accuracy", "f1"]
)

trainer.train(
    train_dataloader=train_loader,
    val_dataloader=val_loader,
    epochs=50,
    monitor="auc",     # ä»¥ AUC ä¸ºæ—©åœåˆ¤æ–­
    patience=5         # 5 è½®æ— æå‡å³ early stop
)
```

---

## âœ… æ­¥éª¤å…­ï¼šä¿å­˜ä¸åŠ è½½æ¨¡å‹

```python
# ä¿å­˜æœ€ä½³æ¨¡å‹
trainer.save_model("checkpoints/best_model.pth")

# åŠ è½½æ¨¡å‹ï¼ˆç”¨äºéƒ¨ç½²æˆ–åç»­è¯„ä¼°ï¼‰
trainer.load_model("checkpoints/best_model.pth")
```

---

## âœ… æ­¥éª¤ä¸ƒï¼šæ¨¡å‹è¯„ä¼°

```python
results = trainer.evaluate(test_dataloader=test_loader)
print(results)
```

è¾“å‡ºç¤ºä¾‹ï¼š

```python
{
  'accuracy': 0.78,
  'auc': 0.84,
  'f1': 0.71,
  'loss': 0.39
}
```

---

## ğŸ“˜ å»ºè®®æ–‡ä»¶ç»“æ„

```
pyhealth_project/
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ 04_define_task.py         âœ… æ„å»ºä»»åŠ¡
â”‚   â”œâ”€â”€ 05_train_model.py         âœ… æ„å»ºæ¨¡å‹ + Trainer
â”‚   â”œâ”€â”€ 06_evaluate_model.py      âœ… æµ‹è¯•è¯„ä¼°
â”‚   â””â”€â”€ 07_save_load_model.py     âœ… æ¨¡å‹ä¿å­˜ä¸åŠ è½½
â”œâ”€â”€ checkpoints/
â”‚   â””â”€â”€ best_model.pth
```

---

## âœ… é˜¶æ®µå®Œæˆæ ‡å‡†

| æ£€æŸ¥ç‚¹                     | æ˜¯å¦å®Œæˆ |
| ----------------------- | ---- |
| æˆåŠŸè®¾ç½®ä»»åŠ¡å¯¹è±¡ï¼ˆå¦‚ AKI äºŒåˆ†ç±»ï¼‰     | âœ…    |
| æ¨¡å‹åˆå§‹åŒ– + æ„å»º Trainer      | âœ…    |
| è®­ç»ƒè¿‡ç¨‹ EarlyStopping ç”Ÿæ•ˆ   | âœ…    |
| æˆåŠŸä¿å­˜/åŠ è½½æ¨¡å‹               | âœ…    |
| æ¨¡å‹è¯„ä¼°å¹¶è¾“å‡º AUC/F1/Accuracy | âœ…    |

---

## ğŸ“Œ é™„åŠ å»ºè®®

* ğŸ’¡ ä½ å¯ä»¥å°è¯•è¿è¡Œ RETAIN æ¨¡å‹ï¼Œå¹¶åœ¨ä¸‹ä¸€é˜¶æ®µè¿›è¡Œå¯è§£é‡Šæ€§åˆ†æï¼›
* ğŸ’¡ æ¨¡å‹è°ƒå‚å»ºè®®è®°å½•æ¯æ¬¡å®éªŒçš„è¶…å‚æ•°ã€ç»“æœåŠç‰ˆæœ¬ï¼ˆå»ºè®®ç”¨ Excel / wandbï¼‰ï¼›
* ğŸ’¡ å¦‚æœæ ·æœ¬ä¸å¹³è¡¡ï¼Œè€ƒè™‘ä½¿ç”¨ weighted loss æˆ– oversamplingï¼›

---

æ˜¯å¦ç»§ç»­è¿›å…¥**ç¬¬å››é˜¶æ®µï¼šæ¨¡å‹éƒ¨ç½²ä¸å¯è§£é‡Šæ€§ï¼ˆRETAIN Attention å¯è§†åŒ–ã€å•æ ·æœ¬é¢„æµ‹ã€APIï¼‰**ï¼Ÿ
æˆ‘å¯ä»¥å¸®ä½ å†™å‡ºå®Œæ•´çš„ attention å¯è§†åŒ–è„šæœ¬å¹¶è®²è§£æ¯ä¸€æ­¥ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ
