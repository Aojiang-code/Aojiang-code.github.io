å¥½çš„ï¼Œä»¥ä¸‹æ˜¯å®Œæ•´çš„ **ç¬¬å››é˜¶æ®µï¼šæ¨¡å‹éƒ¨ç½²ä¸å¯è§£é‡Šæ€§åˆ†æ** å®æ“å­¦ä¹ è®¡åˆ’ï¼Œé‡ç‚¹å›´ç»•ä½ è®­ç»ƒå¥½çš„æ¨¡å‹ï¼ˆå¦‚ RETAIN æˆ– GRU-Dï¼‰è¿›è¡Œï¼š

* âœ… æ¨¡å‹ä¿å­˜ä¸åŠ è½½ï¼›
* âœ… å•æ ·æœ¬é¢„æµ‹ä¸ä¸´åºŠ API å°è£…ï¼›
* âœ… å¯è§£é‡Šæ€§åˆ†æï¼ˆç‰¹åˆ«æ˜¯ RETAIN attention å¯è§†åŒ–ï¼‰ï¼›
* âœ… å‡†å¤‡éƒ¨ç½²åŸå‹ã€‚

---

# ğŸ©» ç¬¬å››é˜¶æ®µï¼šæ¨¡å‹éƒ¨ç½²ä¸å¯è§£é‡Šæ€§åˆ†æï¼ˆRETAIN ä¼˜å…ˆï¼‰

---

## ğŸ¯ é˜¶æ®µç›®æ ‡

1. ä¿å­˜å¹¶åŠ è½½è®­ç»ƒå¥½çš„æœ€ä½³æ¨¡å‹ï¼›
2. å®ç°å¯¹å•ä¸ªæ ·æœ¬çš„æ¨ç†ä¸é¢„æµ‹ï¼›
3. ä½¿ç”¨ RETAIN æ¨¡å‹è¾“å‡ºæ³¨æ„åŠ›æƒé‡å¹¶å¯è§†åŒ–ï¼›
4. æ„å»º API æˆ–æ¨ç†å‡½æ•°åŸå‹ï¼Œä¸ºéƒ¨ç½²åšå‡†å¤‡ã€‚

---

## â± æ¨èç”¨æ—¶ï¼š1 å¤©

---

## âœ… æ­¥éª¤ä¸€ï¼šæ¨¡å‹ä¿å­˜ä¸åŠ è½½

```python
# ä¿å­˜æœ€ä½³æ¨¡å‹
trainer.save_model("checkpoints/retain_best.pth")

# åŠ è½½æ¨¡å‹
trainer.load_model("checkpoints/retain_best.pth")
```

âš ï¸ æ³¨æ„ï¼šåŠ è½½æ¨¡å‹æ—¶å¿…é¡»ä½¿ç”¨ä¸è®­ç»ƒæ—¶ä¸€è‡´çš„ `processed_dataset` æ„å»ºæ¨¡å‹ç»“æ„ã€‚

---

## âœ… æ­¥éª¤äºŒï¼šå•æ ·æœ¬é¢„æµ‹ï¼ˆé€‚åˆä¸´åºŠæ¨ç†ï¼‰

```python
# éšä¾¿é€‰ä¸€ä¸ªæµ‹è¯•æ ·æœ¬
sample = test_ds.samples[0]

# è°ƒç”¨æ¨¡å‹é¢„æµ‹æ¥å£
pred = model.predict([sample])
print(pred)
```

è¾“å‡ºï¼ˆåˆ†ç±»ä»»åŠ¡ï¼‰ï¼š

```python
[{'prediction': 0, 'probability': [0.25, 0.75]}]
```

---

## âœ… æ­¥éª¤ä¸‰ï¼šRETAIN å¯è§£é‡Šæ€§åˆ†æ

> RETAIN æ”¯æŒè¾“å‡ºï¼š
>
> * Î±ï¼ˆvisit-level attentionï¼‰
> * Î²ï¼ˆfeature-level attentionï¼‰

```python
# è¿”å›é¢„æµ‹å€¼ + æ³¨æ„åŠ›æƒé‡
pred, visit_attn, variable_attn = model.forward([sample], return_attention=True)

print("é¢„æµ‹ç»“æœï¼š", pred)
print("visit attention:", visit_attn)
print("variable attention:", variable_attn)
```

---

## âœ… æ­¥éª¤å››ï¼šæ³¨æ„åŠ›æƒé‡å¯è§†åŒ–

### æ–¹æ³•ä¸€ï¼šå˜é‡æ³¨æ„åŠ›çƒ­åŠ›å›¾ï¼ˆæŒ‰ visit å±•ç¤ºï¼‰

```python
import matplotlib.pyplot as plt
import seaborn as sns
import numpy as np

attn_matrix = variable_attn[0]  # shape: [num_visits, num_features]
sns.heatmap(attn_matrix, cmap="viridis", xticklabels=True)
plt.title("Variable Attention per Visit")
plt.xlabel("Feature Index")
plt.ylabel("Visit Index")
plt.show()
```

### æ–¹æ³•äºŒï¼švisit-level é‡è¦æ€§

```python
plt.figure()
plt.plot(visit_attn[0], marker='o')
plt.title("Visit-level Attention Weights")
plt.xlabel("Visit Index")
plt.ylabel("Î±_t")
plt.grid(True)
plt.show()
```

---

## âœ… æ­¥éª¤äº”ï¼šæ„å»ºæ¨ç†å‡½æ•°ï¼ˆå¯å°è£…è¿› APIï¼‰

```python
def predict_aki(sample):
    pred, visit_attn, var_attn = model.forward([sample], return_attention=True)
    return {
        "probability": pred[0],
        "visit_attention": visit_attn[0],
        "variable_attention": var_attn[0]
    }
```

å¯å¯¹æ¥ FastAPI:

```python
from fastapi import FastAPI
app = FastAPI()

@app.post("/predict_aki/")
def predict(sample_dict: dict):
    # ä½ éœ€è¦å†™è§£æå™¨ï¼šå°† dict è½¬ä¸º Sample æ ¼å¼
    result = predict_aki(sample)
    return result
```

---

## ğŸ“‚ æ¨èç›®å½•ç»“æ„

```
pyhealth_project/
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ 07_save_load_model.py       âœ… ä¿å­˜ + åŠ è½½
â”‚   â”œâ”€â”€ 08_single_sample_predict.py âœ… å•æ ·æœ¬æ¨ç†
â”‚   â””â”€â”€ 09_attention_analysis.py    âœ… å¯è§†åŒ– attention
â”œâ”€â”€ api/
â”‚   â””â”€â”€ app.py                      âœ… FastAPI ä¸´åºŠæ¥å£åŸå‹
```

---

## âœ… é˜¶æ®µå®Œæˆæ ‡å‡†

| æ£€æŸ¥ç‚¹                  | æ˜¯å¦å®Œæˆ |
| -------------------- | ---- |
| æˆåŠŸä¿å­˜ä¸åŠ è½½æ¨¡å‹            | âœ…    |
| å®ç°å•æ ·æœ¬é¢„æµ‹è¾“å‡ºæ¦‚ç‡          | âœ…    |
| è¾“å‡ºå¹¶æ‰“å° attention æƒé‡   | âœ…    |
| çƒ­åŠ›å›¾/æŠ˜çº¿å›¾å¯è§†åŒ– attention | âœ…    |
| æ„å»º RESTful é£æ ¼æ¨ç†å‡½æ•°åŸå‹  | âœ…    |

---

## ğŸ” å¯è§£é‡Šæ€§æ‰©å±•å»ºè®®ï¼ˆé€‰åšï¼‰

| æ¨¡å‹          | å¯è§£é‡Šæ€§æ–¹æ³•            | å·¥å…·æ”¯æŒ          |
| ----------- | ----------------- | ------------- |
| RETAIN      | Attention Heatmap | âœ… å†…å»ºæ”¯æŒ        |
| GRU-D       | Feature Impact    | SHAP (éœ€é¢å¤–å°è£…)  |
| Transformer | ç‰¹å¾æ³¨æ„åŠ›å¤´å¯è§†åŒ–         | attention å¯å¯¼å‡º |

---

## ğŸ§  é™„åŠ æ€è€ƒå»ºè®®

* attention é«˜çš„ visit å’Œå˜é‡æ˜¯å¦å¯¹åº”æŸäº› AKI é«˜é£é™©æŒ‡æ ‡ï¼ˆå¦‚æ€¥å‰§ä¸Šå‡çš„è‚Œé…ï¼‰ï¼Ÿ
* ä½ æ˜¯å¦èƒ½æ‰¾åˆ°æ¯ä¸ªç—…äººé¢„æµ‹é”™è¯¯çš„ caseï¼Œå¯¹ç…§ä»–ä»¬çš„ç—…ç¨‹æˆ–æ—¶é—´çº¿åšè¯¯å·®åˆ†æï¼Ÿ

---

æ˜¯å¦ç»§ç»­è¿›å…¥ç¬¬äº”é˜¶æ®µï¼š**å¤šæ¨¡å‹å®éªŒå¯¹æ¯”ä¸æŠ¥å‘Šç”Ÿæˆï¼ˆGRU-D vs RETAIN vs Transformerï¼‰**ï¼Ÿ
æˆ‘å¯ä»¥ä¸ºä½ å‡†å¤‡ä¸€ä»½ç»Ÿä¸€è®­ç»ƒ â†’ å¤šæ¨¡å‹å¯¹æ¯” â†’ é›·è¾¾å›¾è¾“å‡º â†’ æŠ¥å‘Šç»“æ„å»ºè®®çš„æ¨¡æ¿ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ
