éå¸¸å¥½ï¼æˆ‘ä»¬ç°åœ¨æ­£å¼è¿›å…¥ï¼š

---

# ğŸ§  ç¬¬ä¸‰é˜¶æ®µï¼šå»ºæ¨¡ä¸è®­ç»ƒï¼ˆPart 3ï¼‰

## ğŸ¯ ç›®æ ‡

æœ¬é˜¶æ®µå°†ä½¿ç”¨ä½ åˆšåˆšæ„å»ºçš„è‚¾ç—…çºµå‘æ•°æ®é›†ï¼Œåˆ†åˆ«è®­ç»ƒä¸‰ç§æ¨¡å‹è¿›è¡Œ AKI åˆ†ç±»é¢„æµ‹ï¼š

1. **LSTMModel**
2. **GRU-DModel**ï¼ˆæ”¯æŒç¼ºå¤± & ä¸è§„åˆ™æ—¶é—´é—´éš”ï¼‰
3. **RETAINModel**ï¼ˆå¯è§£é‡Šæ€§æ¨¡å‹ï¼‰

æ¯ä¸ªæ¨¡å‹æˆ‘ä¼šåˆ†å¼€è®²è§£ï¼Œå¹¶æä¾›å®Œæ•´ä»£ç  & å®éªŒå¯è§†åŒ–ã€‚

---

# ğŸ”· 3.1 æ¨¡å‹ä¸€ï¼šLSTMModelï¼ˆæ ‡å‡†å…¥é—¨æ¨¡å‹ï¼‰

## âœ… æ¨¡å‹ç®€ä»‹

**LSTM** æ˜¯å¤„ç†æ—¶é—´åºåˆ—æœ€ç»å…¸çš„ç¥ç»ç½‘ç»œç»“æ„ï¼Œç‰¹ç‚¹ï¼š

* èƒ½è®°ä½é•¿æœŸä¾èµ–
* é€‚åˆæ—¶é—´é¡ºåºæ˜ç¡®çš„æ•°æ®ï¼ˆå¦‚éšè®¿è®°å½•ï¼‰
* ä¸å…·å¤‡æ˜¾å¼å¤„ç†ç¼ºå¤±å€¼ & æ—¶é—´é—´éš”çš„èƒ½åŠ›ï¼ˆç›¸æ¯” GRU-Dï¼‰

---

## ğŸ““ Notebookï¼š`03_lstm_model_training.ipynb`

```python
# 03_lstm_model_training.ipynb

from pyhealth.tasks import BinaryPredictionTask
from pyhealth.models import LSTMModel
from pyhealth.trainer import Trainer
from pyhealth.metrics import calc_metrics

# âœ… 1. æ„å»ºä»»åŠ¡ï¼šæ˜¯å¦å‘ç”ŸAKIï¼ˆäºŒåˆ†ç±»ï¼‰
task = BinaryPredictionTask(
    dataset=dataset,
    feature_keys=["creatinine", "bun", "egfr"],  # æ¨¡å‹è¾“å…¥
    label_key="label",                           # æ¨¡å‹è¾“å‡º
    time_order=True
)

# âœ… 2. æ„å»ºæ¨¡å‹
model = LSTMModel(task=task, hidden_size=64)

# âœ… 3. æ‹†åˆ†è®­ç»ƒ/éªŒè¯æ•°æ®ï¼ˆéšæœºæŒ‰æ¯”ä¾‹ï¼‰
train_ds, val_ds = task.split(0.8)

# âœ… 4. åˆå§‹åŒ– Trainer
trainer = Trainer(
    model=model,
    train_dataset=train_ds,
    val_dataset=val_ds,
    epochs=10,
    batch_size=4,
    optimizer_params={"lr": 1e-3},
    metrics=["acc", "auc", "f1", "precision", "recall"]
)

# âœ… 5. æ¨¡å‹è®­ç»ƒ
trainer.train()

# âœ… 6. æ¨¡å‹è¯„ä¼°
metrics = calc_metrics(model, val_ds, metrics=["acc", "auc", "f1"])
print("éªŒè¯é›†è¯„ä¼°ç»“æœï¼š", metrics)
```

---

## ğŸ” è¾“å‡ºè§£é‡Šï¼š

```
Epoch 1: loss=0.68, acc=0.52, auc=0.58
Epoch 2: loss=0.63, acc=0.61, auc=0.70
...
éªŒè¯é›†è¯„ä¼°ç»“æœï¼š {'acc': 0.73, 'auc': 0.78, 'f1': 0.65}
```

ä½ å¯ä»¥é€šè¿‡ `matplotlib` å°†æ¯ä¸ª epoch çš„ aucã€loss å¯è§†åŒ–å±•ç¤ºã€‚

---

## ğŸ“Œ æ¨¡å‹æ€»ç»“ï¼šLSTMModel

| é¡¹ç›® | å†…å®¹                      |
| -- | ----------------------- |
| è¾“å…¥ | å¤šæ—¶é—´ç‚¹çš„å®éªŒå®¤å€¼ï¼ˆè¡€è‚Œé…ã€BUNã€eGFRï¼‰ |
| å¤„ç† | æ¯ä¸ªç—…äººæŒ‰æ—¶é—´é¡ºåºç¼–ç ä¸ºåºåˆ—ï¼Œè¾“å…¥ LSTM  |
| ä¼˜ç‚¹ | é€šç”¨ã€ç»å…¸ã€å¯ä½œä¸º baseline      |
| ç¼ºç‚¹ | ä¸å¤„ç†æ—¶é—´é—´éš”å·®å¼‚ã€ä¸è§£é‡Šâ€œå› æœâ€       |

---

âœ… LSTM æ¨¡å‹è®­ç»ƒå®Œæˆï¼

---

ä¸‹ä¸€èŠ‚ï¼Œæˆ‘ä»¬å°†è¿›å…¥ï¼š

# ğŸ”· 3.2 æ¨¡å‹äºŒï¼šGRU-DModelï¼ˆæ—¶é—´æ•æ„Ÿæ¨¡å‹ï¼‰

è¯¥æ¨¡å‹æ”¯æŒ **æ—¶é—´é—´éš”ç¼–ç  & ç¼ºå¤±å€¼å¤„ç†**ï¼Œéå¸¸é€‚åˆåŒ»å­¦éšè®¿ç±»æ•°æ®ï¼Œæˆ‘ä»¬å°†åœ¨ä¸‹ä¸€æ¡æ¶ˆæ¯ä¸­è¯¦ç»†å±•å¼€ã€‚

æ˜¯å¦ç»§ç»­ï¼Ÿ
å¾ˆå¥½ï¼Œæˆ‘ä»¬ç»§ç»­è¿›å…¥ï¼š

---

# ğŸ”· 3.2 æ¨¡å‹äºŒï¼šGRU-DModelï¼ˆåŒ»å­¦çºµå‘å»ºæ¨¡åˆ©å™¨ï¼‰

## âœ… æ¨¡å‹ç®€ä»‹

**GRU-D**ï¼ˆGated Recurrent Unit with Decayï¼‰ä¸“ä¸ºå¤„ç†**åŒ»ç–—æ—¶é—´åºåˆ—çš„ä¸è§„åˆ™æ€§ä¸ç¼ºå¤±æ€§**è€Œè®¾è®¡ï¼Œè®ºæ–‡ç”±å“ˆä½›å¤§å­¦åœ¨ AAAI 2016 å‘å¸ƒï¼š

* ğŸ‘€ æ”¯æŒç¼ºå¤±å€¼æ˜¾å¼å»ºæ¨¡ï¼ˆåˆ©ç”¨ mask & å‰å€¼å¡«å……ï¼‰
* â±ï¸ å¯åˆ©ç”¨æ—¶é—´é—´éš”è¿›è¡Œâ€œæ—¶é—´è¡°å‡å»ºæ¨¡â€
* ğŸ“Š é€‚åˆ EHRã€å®éªŒå®¤æ£€æŸ¥ã€ç—…æˆ¿ç›‘æµ‹æ•°æ®ç­‰

åœ¨è‚¾ç—…å»ºæ¨¡ä¸­ï¼Œå®ƒèƒ½å¤Ÿï¼š

* è¯†åˆ«æŸé¡¹æ£€æŸ¥ç¼ºå¤±çš„â€œä¿¡å·â€
* è‡ªåŠ¨å»ºæ¨¡ä¸åŒå®éªŒå®¤æ£€æŸ¥ä¹‹é—´çš„åŠ¨æ€å˜åŒ–

---

## ğŸ““ Notebookï¼š`04_grud_model_training.ipynb`

```python
# 04_grud_model_training.ipynb

from pyhealth.models import GRUDModel
from pyhealth.tasks import BinaryPredictionTask
from pyhealth.trainer import Trainer
from pyhealth.metrics import calc_metrics

# âœ… 1. æ„å»ºä»»åŠ¡
task = BinaryPredictionTask(
    dataset=dataset,
    feature_keys=["creatinine", "bun", "egfr"],
    label_key="label",
    time_order=True
)

# âœ… 2. æ„å»ºæ¨¡å‹ï¼ˆGRU-D æ ¸å¿ƒå‚æ•°ï¼‰
model = GRUDModel(task=task, hidden_size=64)

# âœ… 3. æ‹†åˆ†æ•°æ®
train_ds, val_ds = task.split(0.8)

# âœ… 4. åˆå§‹åŒ–è®­ç»ƒå™¨
trainer = Trainer(
    model=model,
    train_dataset=train_ds,
    val_dataset=val_ds,
    epochs=10,
    batch_size=4,
    optimizer_params={"lr": 1e-3},
    metrics=["acc", "auc", "f1"]
)

# âœ… 5. æ¨¡å‹è®­ç»ƒ
trainer.train()

# âœ… 6. éªŒè¯é›†è¯„ä¼°
metrics = calc_metrics(model, val_ds, metrics=["acc", "auc", "f1", "precision", "recall"])
print("éªŒè¯é›†è¯„ä¼°ç»“æœï¼š", metrics)
```

---

## ğŸ” è¾“å‡ºè§£é‡Š

ä½ å¯èƒ½ä¼šçœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š

```
Epoch 1: loss=0.68, acc=0.55, auc=0.63
Epoch 2: loss=0.61, acc=0.66, auc=0.74
...
éªŒè¯é›†è¯„ä¼°ç»“æœï¼š {'acc': 0.74, 'auc': 0.81, 'f1': 0.69}
```

å¯è§ GRU-D èƒ½æœ‰æ•ˆæå‡æ¨¡å‹å¯¹ä¸è§„åˆ™åŒ»ç–—æ•°æ®çš„å»ºæ¨¡èƒ½åŠ›ã€‚

---

## ğŸ“Œ æ¨¡å‹æ€»ç»“ï¼šGRU-DModel

| é¡¹ç›®   | å†…å®¹                     |
| ---- | ---------------------- |
| é€‚ç”¨åœºæ™¯ | ä¸è§„åˆ™éšè®¿æ•°æ®ï¼ˆè‚¾ç—…ã€ICUã€ç”ŸåŒ–æŒ‡æ ‡ç›‘æµ‹ï¼‰ |
| è¾“å…¥   | å®éªŒå®¤å€¼ + ç¼ºå¤±æƒ…å†µ + æ—¶é—´é—´éš”     |
| ç‰¹ç‚¹   | è‡ªåŠ¨å¤„ç†ç¼ºå¤±ä¸æ—¶é—´å·®ï¼Œé²æ£’æ€§å¼º        |
| ä¼˜åŠ¿   | ä¼˜äº LSTM çš„æ³›åŒ–èƒ½åŠ›ï¼Œæ•ˆæœå¾€å¾€æ›´ç¨³   |

---

âœ… GRU-D æ¨¡å‹è®­ç»ƒå®Œæˆï¼

---

æ¥ä¸‹æ¥æˆ‘ä»¬å°†è¿›å…¥ï¼š

# ğŸ”· 3.3 æ¨¡å‹ä¸‰ï¼šRETAINModelï¼ˆå¯è§£é‡Šæ€§æ¨¡å‹ï¼‰

> è¯¥æ¨¡å‹ä¸ä»…å…·æœ‰é¢„æµ‹èƒ½åŠ›ï¼Œè¿˜å…·å¤‡â€œå¯è§£é‡Šæ€§â€ï¼Œå¯æŸ¥çœ‹â€œå“ªäº›å˜é‡åœ¨å“ªäº›æ—¶é—´ç‚¹å½±å“äº†æ¨¡å‹åˆ¤æ–­â€â€”â€”éå¸¸é€‚åˆç§‘ç ”ä¸ä¸´åºŠäº¤ä»˜ã€‚

æ˜¯å¦ç»§ç»­è¿›å…¥ RETAIN æ¨¡å‹è®²è§£ä¸ä»£ç ï¼Ÿ
éå¸¸å¥½ï¼Œæˆ‘ä»¬ç»§ç»­è¿›å…¥ï¼š

---

# ğŸ”· 3.3 æ¨¡å‹ä¸‰ï¼šRETAINModelï¼ˆåŒ»ç–—é¢„æµ‹ä¸­çš„å¯è§£é‡Šæ€§æ¨¡å‹ï¼‰

## âœ… æ¨¡å‹ç®€ä»‹

**RETAIN**ï¼ˆReverse Time Attentionï¼‰ç”±å“¥ä¼¦æ¯”äºšå¤§å­¦æå‡ºï¼Œç”¨äº**å¯è§£é‡ŠåŒ»ç–—é¢„æµ‹**ï¼Œç‰¹åˆ«é€‚åˆåŒ»ç”Ÿå¸Œæœ›çŸ¥é“ï¼š

> ğŸ§ â€œæ¨¡å‹æ˜¯æ ¹æ®å“ªäº›æ—¶é—´ç‚¹ã€å“ªäº›å˜é‡åšå‡ºåˆ¤æ–­çš„ï¼Ÿâ€

RETAIN æ˜¯åŸºäºä¸¤ä¸ªæ³¨æ„åŠ›æœºåˆ¶ï¼š

* **æ—¶é—´æ³¨æ„åŠ› Î±**ï¼šå“ªäº›å°±è¯Šæ—¶é—´æ›´é‡è¦ï¼Ÿ
* **å˜é‡æ³¨æ„åŠ› Î²**ï¼šå“ªäº›ç‰¹å¾å€¼æ›´é‡è¦ï¼Ÿ

å®ƒå¯ä»¥å›ç­”ï¼šâ€œæ˜¯å› ä¸ºè¿‘æœŸè¡€è‚Œé…è¿…é€Ÿä¸Šå‡ï¼Œæ‰é¢„æµ‹æœ‰ AKI é£é™©ã€‚â€

---

## ğŸ““ Notebookï¼š`05_retain_model_training.ipynb`

```python
# 05_retain_model_training.ipynb

from pyhealth.models import RETAINModel
from pyhealth.tasks import BinaryPredictionTask
from pyhealth.trainer import Trainer
from pyhealth.metrics import calc_metrics

# âœ… 1. æ„å»ºä»»åŠ¡ï¼ˆåŒå‰ï¼‰
task = BinaryPredictionTask(
    dataset=dataset,
    feature_keys=["creatinine", "bun", "egfr"],
    label_key="label",
    time_order=True
)

# âœ… 2. åˆå§‹åŒ– RETAIN æ¨¡å‹
model = RETAINModel(task=task, hidden_size=64)

# âœ… 3. æ‹†åˆ†æ•°æ®
train_ds, val_ds = task.split(0.8)

# âœ… 4. è®­ç»ƒå™¨åˆå§‹åŒ–
trainer = Trainer(
    model=model,
    train_dataset=train_ds,
    val_dataset=val_ds,
    epochs=10,
    batch_size=4,
    optimizer_params={"lr": 1e-3},
    metrics=["acc", "auc", "f1"]
)

# âœ… 5. æ¨¡å‹è®­ç»ƒ
trainer.train()

# âœ… 6. æ¨¡å‹è¯„ä¼°
metrics = calc_metrics(model, val_ds, metrics=["acc", "auc", "f1", "precision", "recall"])
print("éªŒè¯é›†è¯„ä¼°ç»“æœï¼š", metrics)
```

---

## ğŸ” è¾“å‡ºç¤ºä¾‹

```
Epoch 1: acc=0.54, auc=0.63
Epoch 2: acc=0.67, auc=0.77
...
éªŒè¯é›†è¯„ä¼°ç»“æœï¼š {'acc': 0.72, 'auc': 0.79, 'f1': 0.68}
```

---

## ğŸ“Š å¯è§£é‡Šæ€§åˆ†æï¼ˆAttention æƒé‡æå–ï¼‰

RETAIN æ”¯æŒè®¿é—®æ³¨æ„åŠ›æƒé‡ï¼ä»¥ä¸‹ä¸ºæå–æ–¹å¼ï¼š

```python
# è·å–æŸä¸ªæ ·æœ¬çš„é¢„æµ‹ + æ³¨æ„åŠ›
sample = val_ds[0]
pred, alpha_weights, beta_weights = model.forward_with_attention(sample["visit"])

print("é¢„æµ‹ç»“æœï¼š", pred)
print("æ—¶é—´æ³¨æ„åŠ› alphaï¼š", alpha_weights)
print("å˜é‡æ³¨æ„åŠ› betaï¼š", beta_weights)
```

ä½ å¯ä»¥å°† `alpha_weights` ç»˜å›¾ï¼Œåˆ†ææ¨¡å‹**å…³æ³¨äº†å“ªå‡ æ¬¡å°±è¯Š**ï¼Œå†åˆ†æ `beta_weights` çœ‹**å…³æ³¨äº†å“ªäº›æŒ‡æ ‡ï¼ˆå¦‚è¡€è‚Œé…ï¼‰**ã€‚

---

## ğŸ“Œ æ¨¡å‹æ€»ç»“ï¼šRETAINModel

| é¡¹ç›®   | å†…å®¹                   |
| ---- | -------------------- |
| é€‚ç”¨åœºæ™¯ | åŒ»å­¦å»ºæ¨¡ä¸­æœ‰å¯è§£é‡Šæ€§éœ€æ±‚çš„åˆ†ç±»ä»»åŠ¡    |
| ä¼˜ç‚¹   | Attention å¯è§†åŒ–ï¼Œç§‘ç ”å±•ç¤ºåˆ©å™¨ |
| è¾“å‡º   | åŒæ—¶æä¾›é¢„æµ‹ç»“æœ + æƒé‡è§£é‡Š      |
| å±€é™   | ç›¸æ¯” GRU-D æ€§èƒ½ç•¥é€Šï¼Œä½†æ›´å¯è§£é‡Š  |

---

âœ… RETAIN æ¨¡å‹è®­ç»ƒå®Œæˆï¼

---

## ğŸ”š æ¨¡å‹å¯¹æ¯”å°ç»“

| æ¨¡å‹     | æ˜¯å¦è€ƒè™‘æ—¶é—´é—´éš” | æ˜¯å¦æ”¯æŒç¼ºå¤±å¤„ç† | æ˜¯å¦å¯è§£é‡Š | æ¨èç”¨é€”         |
| ------ | -------- | -------- | ----- | ------------ |
| LSTM   | âŒ        | âŒ        | âŒ     | baseline     |
| GRU-D  | âœ…        | âœ…        | âŒ     | åŒ»ç–—çºµå‘æ—¶é—´åºåˆ—ä¸»åŠ›æ¨¡å‹ |
| RETAIN | âŒ        | âŒ        | âœ…     | åŒ»å­¦ç ”ç©¶/å‘è¡¨è®ºæ–‡ä¼˜é€‰  |

---

ä¸‹ä¸€é˜¶æ®µæˆ‘ä»¬å°†è¿›å…¥ï¼š

# ğŸ›  ç¬¬å››é˜¶æ®µï¼šæ¨¡å‹éƒ¨ç½²ä¸å¯è§£é‡Šæ€§å±•ç¤º

ä½ å°†å­¦ä¼šï¼š

* æ¨¡å‹ä¿å­˜ã€åŠ è½½ã€è¿ç§»é¢„æµ‹
* å¦‚ä½•å¯¼å‡ºæ³¨æ„åŠ›å›¾è¿›è¡Œå¯è§†åŒ–è§£é‡Š

æ˜¯å¦ç»§ç»­è¿›å…¥ç¬¬å››é˜¶æ®µï¼Ÿ
