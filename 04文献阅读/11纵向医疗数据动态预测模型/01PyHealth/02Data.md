ä»¥ä¸‹æ˜¯å…³äº `pyhealth.data` æ¨¡å—çš„**ä¸­æ–‡å­¦ä¹ ç¬”è®°ï¼ˆæ•°æ®ç»“æ„éƒ¨åˆ†ï¼‰**ï¼Œè¿™æ˜¯ PyHealth çš„æ ¸å¿ƒåŸºç¡€ï¼Œæ‰€æœ‰ä»»åŠ¡éƒ½å›´ç»•è¿™å¥—ç»“æ„å±•å¼€ã€‚

---

# ğŸ“¦ PyHealth æ•°æ®ç»“æ„è¯¦è§£ï¼š`pyhealth.data`

> `pyhealth.data` æ¨¡å—å®šä¹‰äº† PyHealth ä¸­çš„**åŸå­æ•°æ®ç»“æ„**ï¼Œå®ƒæ˜¯æ•´ä¸ªç³»ç»Ÿçš„åº•å±‚åŸºç¡€ã€‚

ä¸»è¦åŒ…æ‹¬ï¼š

1. `Event`ï¼ˆåŸå­äº‹ä»¶ï¼‰
2. `Patient`ï¼ˆç—…äººï¼‰
3. `Visit`ï¼ˆå°±è¯Šï¼Œæœªåœ¨å®˜ç½‘è¯¥èŠ‚åˆ—å‡ºï¼Œä½†å®é™…å¸¸ç”¨ï¼‰

---

## ğŸ§¬ ä¸€ã€`Event`ï¼šåŸå­åŒ»ç–—äº‹ä»¶

æ¯ä¸€ä¸ª `Event` è¡¨ç¤ºä¸€æ¬¡å…·ä½“çš„åŒ»ç–—è¡Œä¸ºï¼Œæ¯”å¦‚ï¼š

* ä¸€æ¬¡å®éªŒå®¤æ£€æŸ¥ï¼ˆå¦‚è¡€è‚Œé… 1.2ï¼‰
* ä¸€æ¬¡è¯Šæ–­ä»£ç ï¼ˆå¦‚ ICD9=428.0ï¼‰
* ä¸€æ¬¡ç”¨è¯è¡Œä¸ºï¼ˆå¦‚ä½¿ç”¨é˜¿å¸åŒ¹æ—ï¼‰

### ğŸ”– å±æ€§

| å±æ€§å          | å«ä¹‰                           |
| ------------ | ---------------------------- |
| `event_type` | äº‹ä»¶ç±»å‹ï¼ˆå¦‚ lab, condition, drugï¼‰ |
| `timestamp`  | æ—¶é—´æˆ³ï¼Œè¡¨ç¤ºäº‹ä»¶å‘ç”Ÿæ—¶é—´                 |
| `attr_dict`  | äº‹ä»¶çš„å±æ€§å­—å…¸ï¼ˆå¦‚æ•°å€¼ã€ä»£ç åã€å•ä½ç­‰ï¼‰         |

### ğŸ§ª ç¤ºä¾‹

```python
from pyhealth.data import Event
from datetime import datetime

event = Event(
    event_type="lab",
    timestamp=datetime(2022, 1, 10),
    attr_dict={"test": "creatinine", "value": 1.2, "unit": "mg/dL"}
)

print(event.event_type)   # "lab"
print(event.timestamp)    # 2022-01-10
print(event.attr_dict)    # {"test": "creatinine", "value": 1.2, "unit": "mg/dL"}
```

### ğŸ”„ å·¥å…·å‡½æ•°

* `Event.from_dict(d: dict)`ï¼šå°†å­—å…¸è½¬ä¸º Event å®ä¾‹

---

## ğŸ§‘â€âš•ï¸ äºŒã€`Patient`ï¼šç—…äººç»“æ„

æ¯ä¸ª `Patient` å¯¹è±¡ä»£è¡¨ä¸€ä¸ªç—…äººï¼ŒåŒ…å«è¯¥ç—…äººçš„æ‰€æœ‰åŒ»ç–—ä¿¡æ¯ï¼ˆäº‹ä»¶é›†åˆï¼‰ã€‚

### ğŸ”– å±æ€§

| å±æ€§å                      | å«ä¹‰                                      |
| ------------------------ | --------------------------------------- |
| `patient_id`             | ç—…äºº ID                                   |
| `data_source`            | æ¥æºï¼ˆå¦‚ MIMIC-IIIã€eICUã€è‡ªå®šä¹‰ï¼‰                |
| `event_type_partitions`  | äº‹ä»¶æŒ‰ç…§ç±»å‹çš„ç»„ç»‡ï¼Œå¦‚ labã€condition ç­‰             |
| `get_events(event_type)` | è·å–æŸä¸€ç±»äº‹ä»¶ï¼Œå¦‚ `get_events("lab")` è¿”å›æ‰€æœ‰å®éªŒå®¤äº‹ä»¶ |

### ğŸ§ª ç¤ºä¾‹

```python
from pyhealth.data import Patient

patient = Patient(
    patient_id="P001",
    data_source="MIMIC"
)

# æ·»åŠ å®éªŒå®¤äº‹ä»¶
patient.add_event(
    event_type="lab",
    timestamp=datetime(2022, 1, 10),
    attr_dict={"test": "bun", "value": 12.5, "unit": "mg/dL"}
)

# è·å–æ‰€æœ‰å®éªŒå®¤æ£€æŸ¥è®°å½•
labs = patient.get_events("lab")
for event in labs:
    print(event.attr_dict)
```

---

## ğŸ§© æ€»ç»“ï¼šæ•°æ®ç»“æ„çš„é€»è¾‘å…³ç³»å›¾

```
Patient
 â””â”€â”€ Visitï¼ˆåœ¨ä»»åŠ¡ä¸­å¸¸ç”¨ç»“æ„ï¼‰
      â””â”€â”€ Event
```

åœ¨è®­ç»ƒæ¨¡å‹æ—¶ï¼ŒPyHealth ä¼šå°† `Patient` åˆ‡åˆ†ä¸ºå¤šä¸ª `Visit`ï¼Œæ¯æ¬¡å°±è¯Šæ˜¯ä¸€ä¸ªå­åºåˆ—ï¼Œ`Visit` å†…åŒ…å«å¤šä¸ª `Event`ã€‚

---

## ğŸ“š å­¦ä¹ å»ºè®®

* ç†è§£ `Event` æ˜¯æœ€å°å•ä½ï¼Œç±»ä¼¼äºâ€œåŒ»ç–—è¯â€
* `Patient` æ˜¯ EHR æ•°æ®çš„æœ€å°ä¸ªä½“ï¼Œæ„æˆé¢„æµ‹æ ·æœ¬çš„åŸææ–™
* åç»­æ¨¡å‹éƒ½å»ºç«‹åœ¨è¿™ä¸¤è€…ä¹‹ä¸Šï¼ˆâ†’ Task â†’ Modelï¼‰

---

å¦‚éœ€æˆ‘ç»§ç»­è®²è§£ `Visit` ç»“æ„ï¼ˆæˆ–ä»æ•°æ®ä¸­è‡ªåŠ¨æ„å»º visit åºåˆ—ï¼‰æˆ–å¸®ä½ åŸºäºè¿™å¥—ç»“æ„å†™æ ·ä¾‹ä»£ç ï¼Œä¹Ÿå¯ä»¥ç»§ç»­å‘Šè¯‰æˆ‘ã€‚æ˜¯å¦ç»§ç»­è¿›å…¥ `pyhealth.data.Visit` éƒ¨åˆ†ï¼Ÿ


éå¸¸å¥½ï¼Œä»¥ä¸‹æ˜¯ä½ æä¾›çš„ `pyhealth.data.Event` ç±»å®˜æ–¹æ–‡æ¡£å†…å®¹ï¼Œæ•´ç†æˆ**ä¸­æ–‡å­¦ä¹ ç¬”è®°ï¼šç»“æ„åŒ–+ç¤ºä¾‹å½¢å¼**ï¼Œæ–¹ä¾¿é•¿æœŸå¤ä¹ ä¸å¿«é€ŸæŸ¥é˜…ã€‚

---

# ğŸ”¬ PyHealth å­¦ä¹ ç¬”è®°ï¼š`pyhealth.data.Event`

## âœ… ä¸€ã€ä»€ä¹ˆæ˜¯ Eventï¼Ÿ

åœ¨ PyHealth ä¸­ï¼Œ`Event` æ˜¯æœ€åŸºæœ¬çš„æ•°æ®ç»“æ„ä¹‹ä¸€ï¼Œè¡¨ç¤ºä¸€æ¬¡**ä¸´åºŠäº‹ä»¶ï¼ˆclinical eventï¼‰**ã€‚
å®ƒä½œä¸ºåç»­ä»»åŠ¡å»ºæ¨¡çš„æœ€å°å•ä½ï¼Œå¯è¡¨ç¤ºï¼š

| ç¤ºä¾‹ç±»å‹    | ç¤ºä¾‹å†…å®¹                   |
| ------- | ---------------------- |
| è¯ç‰©äº‹ä»¶    | ä½¿ç”¨äº†â€œé˜¿å¸åŒ¹æ—â€              |
| è¯Šæ–­äº‹ä»¶    | ICD9 ç¼–ç â€œ428.0â€ï¼ˆå¿ƒåŠ›è¡°ç«­ï¼‰   |
| å®éªŒå®¤æ£€æŸ¥äº‹ä»¶ | è¡€è‚Œé…å€¼ä¸º 1.2 mg/dLï¼Œå‘ç”ŸäºæŸæ—¥æœŸ |

---

## ğŸ§± äºŒã€ç±»å®šä¹‰ç»“æ„

```python
class pyhealth.data.Event
```

### ğŸ”‘ å±æ€§è¯´æ˜

| å±æ€§å          | ç±»å‹         | è¯´æ˜                                              |
| ------------ | ---------- | ----------------------------------------------- |
| `event_type` | `str`      | è¡¨ç¤ºäº‹ä»¶ç±»å‹ï¼Œå¦‚ `"medication"`, `"diagnosis"`, `"lab"` |
| `timestamp`  | `datetime` | è¡¨ç¤ºäº‹ä»¶å‘ç”Ÿæ—¶é—´                                        |
| `attr_dict`  | `dict`     | å­˜å‚¨è¯¥äº‹ä»¶çš„ç»†èŠ‚ï¼Œä¾‹å¦‚è¯ç‰©åç§°ã€æ£€æŸ¥å€¼ã€å•ä½ç­‰                         |

---

## ğŸ§ª ä¸‰ã€åˆå§‹åŒ–ç¤ºä¾‹

```python
from pyhealth.data import Event
from datetime import datetime

# åˆ›å»ºä¸€ä¸ªè¡€è‚Œé…å®éªŒå®¤æ£€æŸ¥äº‹ä»¶
event = Event(
    event_type="lab",
    timestamp=datetime(2022, 1, 15),
    attr_dict={
        "test": "creatinine",
        "value": 1.4,
        "unit": "mg/dL"
    }
)

print(event.event_type)    # lab
print(event.timestamp)     # 2022-01-15 00:00:00
print(event.attr_dict)     # {'test': 'creatinine', 'value': 1.4, 'unit': 'mg/dL'}
```

---

## ğŸ”„ å››ã€ä»å­—å…¸åˆ›å»º `Event`ï¼š`from_dict()`

å¦‚æœä½ æœ‰æ¥è‡ªæ•°æ®åº“æˆ– CSV çš„æ•°æ®è¡Œï¼Œå¯ä»¥ä½¿ç”¨ `from_dict()` å¿«é€Ÿåˆ›å»ºï¼š

```python
# æ¨¡æ‹ŸåŸå§‹æ•°æ®è¡Œ
raw_event = {
    "event_type": "medication",
    "timestamp": datetime(2022, 2, 5),
    "attr_dict": {
        "drug_name": "aspirin",
        "dose": 100,
        "unit": "mg"
    }
}

# ä½¿ç”¨ç±»æ–¹æ³•æ„é€  Event å®ä¾‹
event = Event.from_dict(raw_event)

print(event.event_type)    # medication
print(event.attr_dict)     # {'drug_name': 'aspirin', 'dose': 100, 'unit': 'mg'}
```

ğŸ“Œ æ³¨æ„ï¼š

* `from_dict()` æ˜¯ä¸€ä¸ªç±»æ–¹æ³•ï¼ˆclassmethodï¼‰
* `attr_dict` çš„å†…å®¹æ²¡æœ‰å¼ºçº¦æŸï¼Œæ”¯æŒä»»æ„ç»“æ„ï¼Œé€‚åˆä¸åŒç±»å‹ä»»åŠ¡

---

## ğŸ“Œ äº”ã€ä½¿ç”¨åœºæ™¯æ€»ç»“

| åœºæ™¯        | ç¤ºä¾‹                                                            |
| --------- | ------------------------------------------------------------- |
| è¡¨ç¤ºä¸€æ¬¡å®éªŒå®¤æ£€æŸ¥ | `"lab", timestamp, {"test": "BUN", "value": 12.5}`            |
| è¡¨ç¤ºä¸€æ¬¡è¯Šæ–­    | `"diagnosis", timestamp, {"icd9": "428.0"}`                   |
| è¡¨ç¤ºä¸€æ¬¡ç”¨è¯    | `"medication", timestamp, {"drug": "metformin", "dose": 500}` |

`Event` å¸¸è¢«ç»„ç»‡è¿› `Visit`ï¼ˆä¸€æ¬¡å°±è¯Šï¼‰ï¼Œæˆ–ç›´æ¥åŠ å…¥ `Patient` ä¸­ã€‚

---

## âœ… å°ç»“

| ç‰¹æ€§   | è¯´æ˜                     |
| ---- | ---------------------- |
| çµæ´»   | æ”¯æŒä»»æ„åŒ»ç–—äº‹ä»¶ç±»å‹             |
| å¯æ‰©å±•  | `attr_dict` å¯å­˜å‚¨ä»»æ„é”®å€¼å¯¹   |
| æ˜“æ„å»º  | æ”¯æŒ `from_dict()` ä»å­—å…¸åˆ›å»º |
| åŸºç¡€ä½œç”¨ | åç»­ä»»åŠ¡æ„å»ºã€æ¨¡å‹è¾“å…¥ä¾èµ–å®ƒ         |

---

å¦‚ä½ å¸Œæœ›ç»§ç»­äº†è§£ `Visit`ã€`Patient` çš„ç»„ç»‡æ–¹å¼ï¼Œæˆ–éœ€è¦æˆ‘å¸®ä½ å†™ä¸€ç»„ Event â Visit â Patient çš„æ•°æ®ç»“æ„æ„é€ è„šæœ¬ï¼Œæˆ‘å¯ä»¥ç»§ç»­è¡¥å……ä¸‹ä¸€èŠ‚å­¦ä¹ ç¬”è®°ã€‚éœ€è¦ç»§ç»­å—ï¼Ÿ


éå¸¸å¥½ï¼ä»¥ä¸‹æ˜¯ä½ æä¾›çš„ `pyhealth.data.Patient` çš„å®˜æ–¹æ–‡æ¡£å†…å®¹ï¼Œæˆ‘å·²æ•´ç†ä¸º**ç»“æ„æ¸…æ™°ã€é€‚åˆé•¿æœŸå¤ä¹ çš„ä¸­æ–‡å­¦ä¹ ç¬”è®°**ã€‚

---

# ğŸ‘©â€âš•ï¸ PyHealth å­¦ä¹ ç¬”è®°ï¼š`pyhealth.data.Patient`

---

## âœ… ä¸€ã€Patient æ˜¯ä»€ä¹ˆï¼Ÿ

`Patient` æ˜¯ PyHealth ä¸­çš„åŸºç¡€ç»“æ„ä¹‹ä¸€ï¼Œä»£è¡¨ä¸€ä¸ªç—…äººåŠå…¶æ•´ä¸ªåŒ»ç–—äº‹ä»¶è®°å½•é›†åˆã€‚æ¯ä¸ª `Patient`ï¼š

* æ‹¥æœ‰å”¯ä¸€ IDï¼ˆ`patient_id`ï¼‰
* æ‹¥æœ‰è‹¥å¹²æ¬¡åŒ»ç–—å°±è¯Šï¼ˆé€šè¿‡äº‹ä»¶åºåˆ—ä½“ç°ï¼‰
* å¯ä»¥ä½œä¸ºä»»åŠ¡æ¨¡å‹çš„è¾“å…¥æ•°æ®

---

## ğŸ§± äºŒã€ç±»å®šä¹‰ç»“æ„

```python
class pyhealth.data.Patient(patient_id, data_source)
```

| å‚æ•°å           | ç±»å‹                     | è¯´æ˜              |
| ------------- | ---------------------- | --------------- |
| `patient_id`  | `str`                  | ç—…äººå”¯ä¸€æ ‡è¯†ç¬¦         |
| `data_source` | `pl.DataFrame`ï¼ˆpolarsï¼‰ | è¯¥ç—…äººæ‰€æœ‰äº‹ä»¶ï¼ˆæŒ‰æ—¶é—´æˆ³æ’åºï¼‰ |

---

## ğŸ”‘ ä¸‰ã€å±æ€§è¯¦è§£

| å±æ€§å                     | ç±»å‹                        | è¯´æ˜                       |
| ----------------------- | ------------------------- | ------------------------ |
| `patient_id`            | `str`                     | ç—…äººç¼–å·                     |
| `data_source`           | `pl.DataFrame`            | å­˜å‚¨æ‰€æœ‰äº‹ä»¶çš„ Polars è¡¨æ ¼        |
| `event_type_partitions` | `Dict[str, pl.DataFrame]` | æŒ‰äº‹ä»¶ç±»å‹ï¼ˆå¦‚ labã€drugï¼‰æ‹†åˆ†åçš„äº‹ä»¶è¡¨ |

---

## ğŸ”„ å››ã€æ–¹æ³•ï¼š`get_events()`ï¼ˆæ ¸å¿ƒæ–¹æ³•ï¼‰

### æ–¹æ³•ç­¾åï¼š

```python
Patient.get_events(
    event_type=None,
    start=None,
    end=None,
    filters=None,
    return_df=False
)
```

### åŠŸèƒ½ï¼š

è·å–æŒ‡å®šç±»å‹ + æ—¶é—´æ®µ + æ¡ä»¶ç­›é€‰çš„äº‹ä»¶ï¼ˆè¿”å›äº‹ä»¶å¯¹è±¡æˆ– DataFrameï¼‰

---

### âœ¨ å‚æ•°è¯´æ˜ï¼š

| å‚æ•°å             | ç±»å‹            | è¯´æ˜                                            |
| --------------- | ------------- | --------------------------------------------- |
| `event_type`    | `str` å¯é€‰      | é™å®šè·å–å“ªç±»äº‹ä»¶ï¼ˆå¦‚ `"lab"`ï¼‰                           |
| `start` / `end` | `datetime`    | é™å®šæ—¶é—´èŒƒå›´                                        |
| `filters`       | `List[tuple]` | å±æ€§è¿‡æ»¤æ¡ä»¶ï¼Œå¦‚ `[("value", "!=", 0)]`               |
| `return_df`     | `bool`        | è‹¥ä¸º `True`ï¼Œè¿”å› `pl.DataFrame`ï¼›å¦åˆ™è¿”å› `Event` å¯¹è±¡åˆ—è¡¨ |

---

### ğŸ§ª ç¤ºä¾‹

```python
from pyhealth.data import Patient
from datetime import datetime

# åˆå§‹åŒ–ç—…äººå¯¹è±¡ï¼ˆæ„é€ ç©ºæ•°æ®ç¤ºä¾‹ï¼‰
patient = Patient(patient_id="P001", data_source=None)

# å‡è®¾æˆ‘ä»¬å·²ç»å‘ patient æ·»åŠ äº†å¤šæ¬¡ lab äº‹ä»¶...

# è·å–æ‰€æœ‰ lab ç±»å‹çš„äº‹ä»¶
labs = patient.get_events(event_type="lab")

# è·å– 2022 å¹´ä¹‹åçš„å®éªŒå®¤äº‹ä»¶
labs_2022 = patient.get_events(
    event_type="lab",
    start=datetime(2022, 1, 1)
)

# è·å–å€¼ä¸ä¸º 0 çš„äº‹ä»¶ï¼ˆè‡ªå®šä¹‰å±æ€§è¿‡æ»¤ï¼‰
labs_filtered = patient.get_events(
    event_type="lab",
    filters=[("value", "!=", 0)]
)
```

---

## ğŸ§© äº”ã€`Patient` çš„å…¸å‹ä½¿ç”¨æµç¨‹ï¼ˆä¸ Event è”åŠ¨ï¼‰

```python
from pyhealth.data import Event, Patient
from datetime import datetime

# åˆ›å»ºç—…äºº
patient = Patient(patient_id="P001", data_source=None)

# æ·»åŠ äº‹ä»¶ï¼ˆæ¨¡æ‹Ÿï¼‰
event1 = Event("lab", datetime(2022, 1, 1), {"test": "BUN", "value": 12.5})
event2 = Event("lab", datetime(2022, 1, 10), {"test": "Creatinine", "value": 1.3})

# é€šè¿‡ add_event æ·»åŠ ï¼ˆå®é™…è°ƒç”¨ task/dataset æ—¶ç”±ç³»ç»Ÿè‡ªåŠ¨æ·»åŠ ï¼‰
patient.add_event(event1)
patient.add_event(event2)

# è·å–äº‹ä»¶
lab_events = patient.get_events(event_type="lab")
for e in lab_events:
    print(e.timestamp, e.attr_dict)
```

---

## ğŸ“Œ å…­ã€ä½¿ç”¨æŠ€å·§å°ç»“

| æŠ€èƒ½           | ç¤ºä¾‹                                                      |
| ------------ | ------------------------------------------------------- |
| è·å–æŸç±»äº‹ä»¶       | `get_events("lab")`                                     |
| è®¾å®šæ—¶é—´æ®µè¿‡æ»¤      | `start=datetime(...)`                                   |
| å¤šæ¡ä»¶è¿‡æ»¤        | `filters=[("value", "!=", 0), ("unit", "==", "mg/dL")]` |
| è¾“å‡º DataFrame | `return_df=True`                                        |

---

## âœ… æ€»ç»“

| ç‰¹æ€§    | æè¿°                                  |
| ----- | ----------------------------------- |
| æ ¸å¿ƒä½œç”¨  | å­˜å‚¨ç—…äººæ‰€æœ‰åŒ»ç–—äº‹ä»¶                          |
| å…¸å‹ç»“æ„  | Patient âŸ¶ \[Event, Event, Event...] |
| å¯æ”¯æŒè¿‡æ»¤ | ç±»å‹ã€æ—¶é—´ã€å±æ€§                            |
| å¸¸é…åˆä½¿ç”¨ | `Visit`ã€`Event`ã€`Task`ã€`Dataset`    |

---

æ˜¯å¦ç»§ç»­è¿›å…¥ `Visit` çš„ç»“æ„ä¸ä½¿ç”¨è¯´æ˜ï¼Ÿè¿˜æ˜¯å¸Œæœ›æˆ‘å°† Event + Patient æ„é€ é€»è¾‘æ•´ç†æˆå®Œæ•´çš„è„šæœ¬æ ·ä¾‹ï¼ˆå¦‚ç”¨äºè‡ªå®šä¹‰æ•°æ®æ„å»ºï¼‰ï¼Ÿ
