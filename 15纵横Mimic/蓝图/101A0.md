好，那我们就正式从 **A0：准备 & 文档搭建** 开干。
我会按你现在的工程实际情况，给你**可以直接在终端&编辑器里执行/粘贴**的步骤。

后面 A1、A2… 都会建立在今天这一步之上。

---

## A0-1：在 `docs/aki/` 里新建两份“总纲文档”

项目根目录假设还是：

```bash
/public/home/aojiang/mimic/15纵横Mimic
```

### 1️⃣ 在终端里创建文件

```bash
cd /public/home/aojiang/mimic/15纵横Mimic/docs/aki

# 新建 KDIGO 定义文档
touch 03_kdigo_definition.md

# 新建建模总规划文档
touch 04_modeling_plan.md
```

### 2️⃣ `03_kdigo_definition.md` 建议内容（直接复制进去）

```markdown
# 03 — AKI KDIGO 定义与实现方案（草案）

> 版本：v0.1（只写思路，不要求一次定稿）

## 1. KDIGO AKI 标准回顾（教科书版）

### 1.1 血清肌酐（Scr）标准

- **48 小时内** Scr 升高 ≥ 0.3 mg/dL  
- 或 **7 天内** Scr 升高到基线的 ≥ 1.5 倍  
- 或 Scr 上升到基线的 ≥ 2.0 / 3.0 倍（对应 Stage 2 / 3）

### 1.2 尿量标准

- Stage 1：尿量 < 0.5 ml/kg/h 持续 6–12 小时  
- Stage 2：尿量 < 0.5 ml/kg/h 持续 ≥ 12 小时  
- Stage 3：尿量 < 0.3 ml/kg/h 持续 ≥ 24 小时，或无尿 ≥ 12 小时

> 备注：本项目中，尿量部分暂定为“后续增强模块”，先实现 Scr 版 KDIGO，再逐步加尿量。

---

## 2. 本项目中的 KDIGO 实现原则

### 2.1 总体策略

- **第一版（v1）**：仅基于 Scr 的 KDIGO，实现清晰、可复现的算法；
- 后续再加入尿量，形成 **Scr+UO 联合 KDIGO（v2）**；
- 所有计算以 **ICU stay（stay_id）** 为单位。

### 2.2 时间窗口与粒度

- Scr 使用的时间范围：
  - 默认：`admittime - 7 天` 到 `dischtime + 1 天`；
- KDIGO 判定时间粒度：
  - 先按原始测量时间点计算，不做插值；
  - 需要轨迹分析时，再按固定间隔（如 6h / 12h）重采样。

---

## 3. 基线 Scr（Baseline Creatinine）定义

> 目前先采用“简单 & 保守”方案，后续可以再尝试 MDRD 反推等高级方案。

1. **优先级 1：入院前 7 天内的最低 Scr**
   - 如果在 `admittime - 7 天 ~ admittime` 有测量，取这段时间内的最小值。

2. **优先级 2：住院期间（ICU 前）的最低 Scr**
   - 如果没有 7 天内数据，则在 `admittime ~ intime` 之间寻找最低 Scr。

3. **优先级 3：ICU 前首次 Scr**
   - 如 ICU 前完全无 Scr 记录，则取 ICU 前第一次 Scr 作为基线。

4. **无法确定基线时的处理**
   - 将该 stay 标记为 `baseline_scr_missing = 1`；
   - 仍可参与“绝对值升高 ≥ 0.3 mg/dL”部分的 KDIGO 判定；
   - 但基于倍数（1.5/2/3 倍）的分期需谨慎解释。

> 未来可以在此基础上增加：  
> - 使用 MDRD 反推 Scr（假设 eGFR 75 ml/min/1.73m²）  
> - 使用门诊/前次住院 Scr 等信息。

---

## 4. Scr & 尿量时间序列视图设计

### 4.1 Scr 时间序列视图：`aki_scr_timeseries`

- 字段设计：
  - `stay_id`
  - `charttime`
  - `scr_mg_dl`（单位统一为 mg/dL）

- 来源：
  - `mimiciv_hosp.labevents` 与 `aki_cohort` 联合；
  - 过滤 Scr 相关的 itemid（见 5.1）。

### 4.2 尿量时间序列视图：`aki_uo_timeseries`（预留）

- 字段设计：
  - `stay_id`
  - `charttime`
  - `urine_output_ml`

- 来源：
  - `mimiciv_icu.outputevents` 与 `aki_cohort` 联合；
  - 暂不实现按体重归一化（ml/kg/h），后续在 Python 中处理。

---

## 5. MIMIC-IV 中的 itemid 对照表（持续补充）

### 5.1 Scr

- 实验室项目：
  - `Creatinine` → itemid = 50912（MIMIC-IV v2.2）

> 后续若发现更多 creatinine 相关 itemid，在此处补充。

### 5.2 尿量（预留）

- 尿量相关项目（待查官方代码本后填写）：
  - 待补充：
    - `Urine output` / `Urine 24hr` 等的 itemid 列表。

---

## 6. KDIGO 分期输出字段约定

在 stay 级别，我们至少需要以下字段：

- `kdigo_stage_max`：ICU 期间的最大 KDIGO stage（0–3）  
- `kdigo_stage_first`：首次达到 AKI 时的阶段  
- `kdigo_onset_time`：首次满足 KDIGO Stage ≥ 1 时的时间（相对于 `intime`）  
- `kdigo_progression`：是否从 stage 1 进展到更高阶段（0/1）  
- `kdigo_persistent`：是否为“持续 AKI”（例如：stage ≥1 持续 ≥ 48 小时）

后续可增加：

- `kdigo_recovery_time`：首次恢复到 < stage 1 的时间  
- `kdigo_ever_stage3`：是否达到 stage 3（0/1）

---

## 7. 实现路线回顾

1. **A1 阶段**：先实现 `aki_scr_timeseries`、`aki_uo_timeseries` 两个基础视图；
2. **A2 阶段**：在 Python 中实现基线 Scr + KDIGO 逻辑，生成 `aki_kdigo_summary`；
3. **后续阶段**：在建模特征、轨迹分析、前端展示中，都统一使用这些定义。
```

> 你可以先照搬这份草稿，后面随着实现逐步往里面填“更具体的公式和例子”。

---

### 3️⃣ `04_modeling_plan.md` 建议内容（也可以直接复制）

```markdown
# 04 — AKI 建模与分析总规划

> 版本：v0.1（规划为主，后续再写“实际完成情况”）

## 1. 总体目标

- 在 MIMIC-IV ICU 成人 AKI 患者队列上，完成从 **描述性分析 → 传统回归 → 机器学习 → 轨迹模型** 的完整链条。
- 所有模型都基于同一个、可复现的数据构建流程（Feature Store v0）。

---

## 2. 预测任务定义（Tasks）

### 2.1 Task 1：ICU 死亡预测（基线模型）

- 人群：`aki_cohort` + 有效 KDIGO 信息的 ICU stay；
- 时间点：ICU 入科后前 24 小时内收集特征（T0 = intime+24h）；
- 标签：`icu_mortality`（ICU 内死亡：0/1）；
- 特征示例：
  - 人口学：age, gender, race；
  - 既往疾病：Charlson Score / comorbidity flags（后续补充）；
  - KDIGO：`kdigo_stage_max`、`kdigo_stage_first`；
  - 实验室：Scr, BUN, Na, K, WBC, Hb, PLT（首日中位数或最大值）；
  - ICU 信息：careunit, icu_los_days（截断至某上限）。

### 2.2 Task 2：AKI 进展预测

- 人群：至少已达到 KDIGO Stage 1 的 AKI 患者；
- 时间点：首次达到 Stage 1 后 24 小时（T0 = onset+24h）；
- 标签：在随后 72h 内是否进展到 Stage 3 (`progress_to_stage3`：0/1)；
- 特征示例：
  - onset 前后的 Scr 动态；
  - 当前 KDIGO stage；
  - 实验室异常情况；
  - 用药与干预（后续拓展）。

### 2.3 Task 3（预留）：RRT 或长期结局

- 暂留空位，未来扩展为 RRT 使用、院外死亡、长期随访等任务。

---

## 3. 特征体系（Feature Taxonomy）

### 3.1 Patient-level（静态）

- age, gender, race, insurance；
- comorbidities（高血压、糖尿病、CKD、HF 等）。

### 3.2 ICU-admission-level

- first_careunit；
- SOFA / SAPS-II / OASIS（若后续加入）；
- ICU LOS（截断）。

### 3.3 Lab-based Features

- 首日实验室（0–24h）：
  - Scr, BUN, Na, K, WBC, Hb, PLT 的 median / min / max；
- KDIGO 相关：
  - baseline Scr；
  - 最大 Scr；
  - Scr slope（如 24h 内变化率）。

### 3.4 KDIGO-derived Features

- `kdigo_stage_max`；
- `kdigo_stage_first`；
- `kdigo_onset_time`（相对于 ICU 入科的小时数）；
- `kdigo_progression`（是否从 1 → 2/3）；
- `kdigo_persistent`（是否持续）。

### 3.5 Trajectory-based Features（后期加入）

- Scr 轨迹聚类类别（trajectory_cluster）；
- 每个轨迹类别的代表性参数（峰值时间、峰值幅度等）。

---

## 4. 模型家族与评估指标

### 4.1 基线统计模型

- Logistic 回归：
  - 使用 `statsmodels`，输出 OR / 95% CI / p-value；
  - 作为临床可解释的基线模型。
- Cox 回归（若定义好随访时间）：
  - 使用 `lifelines`。

### 4.2 机器学习模型

- Random Forest；
- Gradient Boosting（XGBoost / LightGBM）；
- 正则化 Logistic（L1/L2）。

统一评估指标：

- AUROC, AUPRC；
- Accuracy, F1（次要）；
- Brier score, Calibration curve（校准）。

### 4.3 轨迹模型

- Scr 时间序列聚类：
  - KMeans / 层次聚类 + 手工选择 K；
  - 后续可尝试 DTW + 聚类或 GBTM。
- Role：
  - 轨迹类别作为高层次表型，纳入回归 / ML 模型。

---

## 5. 数据拆分与验证策略

- 基本策略：
  - 按患者 ID 分层（同一患者只能出现在 train 或 test，一侧）；
  - 推荐：
    - 70% train / 15% val / 15% test；
  - 或时间切分（某年份之前为 train，之后为 test）。

- 交叉验证：
  - 至少 5-fold CV（在 train+val 上）；
  - 使用相同的拆分进行不同模型对比。

---

## 6. 工程实现规划（代码层面）

### 6.1 主要 Python 模块

- `backend/aki/features.py`
  - 加载 & 合并特征视图；
  - 处理缺失值、标准化、类别编码；
  - 对外暴露 `load_aki_ml_dataset(...)` 函数。

- `backend/aki/models_logistic.py`
  - 封装 logistic / Cox 模型训练 & 结果导出。

- `backend/aki/models_ml.py`
  - 封装 RF / XGB / LGBM；
  - 输出 metrics + feature importance。

- `backend/aki/models_trajectory.py`
  - 轨迹数据准备和聚类；
  - 将聚类结果写回 summary 表/视图。

### 6.2 输出文件约定（放在 `outputs/aki/`）

- `aki_ml_dataset.parquet` / CSV；
- `aki_logistic_results.json`；
- `aki_ml_metrics.json`；
- `aki_feature_importance_*.json`；
- `aki_trajectory_summary.csv/json`。

---

## 7. 版本里程碑

- **AKI v0.1**：  
  - ICD AKI cohort + 首日实验室 + 前端页面（已完成）。

- **AKI v0.2**：  
  - KDIGO 实现（Scr 版）+ KDIGO summary 表 + 基线 logistic 回归。

- **AKI v0.3**：  
  - ML 模型（RF / XGB）+ 指标 JSON + 前端 ROC/重要性图。

- **AKI v0.4**：  
  - Scr 轨迹聚类 + 表型分析 + 前端轨迹视图。

- **AKI v1.0**：  
  - 加入尿量 KDIGO；
  - 完整论文级结果 & 报告。
```

---

## A0-2：给 backend/aki/ 建好代码骨架

这一步的目的只是：**先把文件和函数壳子建好，后面每个节点往里面填实现。**

在项目根目录执行：

```bash
cd /public/home/aojiang/mimic/15纵横Mimic/backend/aki

# 确保有 __init__.py
touch __init__.py

# 新建几个模块文件（如果已经有，就跳过）
touch kdigo_timeseries.py kdigo_labels.py features.py models_logistic.py models_ml.py models_trajectory.py
```

然后你可以在每个文件里先放一个最小的骨架，例如：

**`kdigo_timeseries.py`：**

```python
"""
AKI KDIGO - 时间序列相关工具

- 从数据库加载 Scr / 尿量时间序列
- 后续会在这里做重采样、插值等处理
"""

from typing import Optional
import pandas as pd
from sqlalchemy.engine import Engine


def load_scr_timeseries(engine: Engine, limit: Optional[int] = None) -> pd.DataFrame:
    """
    从 aki_scr_timeseries 视图中读取 Scr 时间序列（后续 A1 实现）

    Parameters
    ----------
    engine : sqlalchemy Engine
    limit : Optional[int]
        如果不为 None，则只取前 limit 个 stay，便于调试。

    Returns
    -------
    pd.DataFrame
        包含至少: stay_id, charttime, scr_mg_dl
    """
    raise NotImplementedError("A1 阶段再来实现我")
```

其它文件也可以类似写一个 `raise NotImplementedError` 占位，这样在还没实现前不会被误用。

（如果你希望，我也可以一次性给出所有这些文件的建议骨架代码，不过现在先保证 A0 完成就好。）

---

## A0-3：给 SQL 放一个专门目录

在根目录执行：

```bash
cd /public/home/aojiang/mimic/15纵横Mimic/backend/sql
mkdir -p aki

cd aki
touch aki_scr_timeseries.sql aki_uo_timeseries.sql aki_kdigo_summary.sql
```

当前可以先不写内容，A1/A2 时我们再补 SQL。

---

## A0-4：做一次小提交（方便以后回溯）

在项目根目录：

```bash
cd /public/home/aojiang/mimic/15纵横Mimic

git status  # 看看新增了哪些文件
git add docs/aki/03_kdigo_definition.md docs/aki/04_modeling_plan.md backend/aki backend/sql/aki
git commit -m "A0: add KDIGO & modeling docs, AKI module skeleton"
```

> 这一步让“路线 A 的起点”形成一个很清晰的 commit，之后你回顾历史会很舒服。

---

到这里，**A0 已经算是完成了：**

* 文档有了清晰的骨架；
* 代码和 SQL 有了放东西的“抽屉”；
* Git 上有一个干净的起点。

---

如果你愿意，下一步我们就可以进入 **A1：实现 `aki_scr_timeseries` / `aki_uo_timeseries`**。
我可以直接帮你写第一版 `aki_scr_timeseries.sql`，你在 psql 里执行看看性能和效果。
